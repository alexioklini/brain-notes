<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brain Notes</title>
<script src="https://cdn.jsdelivr.net/npm/lucide@0.309.0/dist/umd/lucide.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê Design System (Health App) ‚ïê‚ïê‚ïê */
:root {
  --bg: #0d0d0d; --bg2: #111111; --bg3: #161616;
  --card: rgba(255,255,255,0.03); --card-hover: rgba(255,255,255,0.06);
  --border: rgba(255,255,255,0.06); --border-hover: rgba(255,255,255,0.12);
  --text: #f0f0f0; --text2: rgba(255,255,255,0.65); --text3: rgba(255,255,255,0.45); --text4: rgba(255,255,255,0.25);
  --cyan: #00D4FF; --green: #00E676; --purple: #B388FF; --orange: #FF9100;
  --pink: #FF4081; --yellow: #FFD600; --blue: #4a90d9; --red: #FF5252;
  --radius: 8px; --transition: 150ms ease;
  --sidebar-w: 260px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:15px;line-height:1.6}
::selection{background:rgba(0,212,255,.2)}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.15)}
a{color:var(--cyan);text-decoration:none}

/* ‚ïê‚ïê‚ïê Layout ‚ïê‚ïê‚ïê */
#app{display:flex;height:100vh}

/* ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê */
#sidebar{width:var(--sidebar-w);background:var(--bg2);display:flex;flex-direction:column;border-right:1px solid var(--border);flex-shrink:0;transition:width 200ms}
#sidebar.collapsed{width:0;overflow:hidden;border:none}
.sb-header{padding:16px 14px 8px;display:flex;align-items:center;gap:8px}
.sb-header h1{font-size:13px;font-weight:600;color:var(--text);flex:1;display:flex;align-items:center;gap:6px}
.sb-header h1 svg{color:var(--cyan)}
.sb-btn{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all var(--transition)}
.sb-btn:hover{background:var(--card-hover);color:var(--text)}

.sb-section{padding:4px 8px}
.sb-section-title{font-size:11px;font-weight:500;color:var(--text4);text-transform:uppercase;letter-spacing:.5px;padding:8px 6px 4px}

.sb-search{margin:4px 8px 8px;position:relative}
.sb-search input{width:100%;padding:6px 10px 6px 30px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;outline:none;transition:border-color var(--transition)}
.sb-search input:focus{border-color:var(--cyan)}
.sb-search svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text4);width:13px;height:13px;pointer-events:none}

.page-list{flex:1;overflow-y:auto;padding:0 4px 8px}
.page-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:6px;cursor:pointer;color:var(--text2);font-size:13px;transition:all var(--transition);user-select:none;position:relative}
.page-item:hover{background:var(--card-hover);color:var(--text)}
.page-item.active{background:rgba(0,212,255,.08);color:var(--text)}
.page-item .p-icon{display:inline-flex;align-items:center;justify-content:center;width:20px;flex-shrink:0;color:var(--text3)}
.page-item .p-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.page-item .p-toggle{opacity:0;transition:opacity var(--transition);color:var(--text4)}
.page-item:hover .p-toggle{opacity:1}
.page-item .p-add{opacity:0;transition:opacity var(--transition);color:var(--text4)}
.page-item:hover .p-add{opacity:1}
.page-children{padding-left:16px}
.page-children.collapsed{display:none}

.sb-new-page{display:flex;align-items:center;gap:6px;padding:6px 12px;margin:4px 8px;border-radius:6px;cursor:pointer;color:var(--text3);font-size:13px;transition:all var(--transition);border:none;background:none;width:calc(100% - 16px)}
.sb-new-page:hover{background:var(--card-hover);color:var(--text)}

/* ‚ïê‚ïê‚ïê Main ‚ïê‚ïê‚ïê */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

/* Topbar */
.topbar{height:42px;display:flex;align-items:center;padding:0 16px;gap:8px;border-bottom:1px solid var(--border);flex-shrink:0}
.topbar .breadcrumbs{display:flex;align-items:center;gap:4px;font-size:13px;color:var(--text3);flex:1;min-width:0}
.topbar .breadcrumbs span{white-space:nowrap;cursor:pointer}
.topbar .breadcrumbs span:hover{color:var(--text)}
.topbar .breadcrumbs .sep{color:var(--text4)}
.topbar .breadcrumbs .current{color:var(--text);font-weight:500}
.tb-btn{background:none;border:none;color:var(--text3);cursor:pointer;padding:5px;border-radius:4px;display:flex;align-items:center;transition:all var(--transition)}
.tb-btn:hover{background:var(--card-hover);color:var(--text)}

/* ‚ïê‚ïê‚ïê Page Content ‚ïê‚ïê‚ïê */
#page-area{flex:1;overflow-y:auto;display:flex;justify-content:center}
.page-content{max-width:720px;width:100%;padding:40px 24px 100px;position:relative}

/* Cover */
.page-cover{height:200px;border-radius:0 0 var(--radius) var(--radius);background-size:cover;background-position:center;margin:-40px -24px 20px;position:relative}
.page-cover:hover .cover-actions{opacity:1}
.cover-actions{position:absolute;bottom:10px;right:10px;opacity:0;transition:opacity var(--transition);display:flex;gap:4px}

/* Page header */
.page-header{margin-bottom:24px}
.page-icon{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;transition:background var(--transition);color:var(--accent)}
.page-icon:hover{background:var(--card-hover)}
.page-title{font-size:36px;font-weight:700;color:var(--text);border:none;background:none;outline:none;width:100%;line-height:1.2;margin:8px 0 4px;font-family:inherit;display:block}
.page-title:empty::before{content:attr(placeholder);color:var(--text4)}
.page-title::placeholder{color:var(--text4)}
.page-meta{font-size:12px;color:var(--text4);margin-bottom:4px}
.page-header-actions{display:flex;gap:8px;margin-top:4px;opacity:0;transition:opacity var(--transition)}
.page-header:hover .page-header-actions{opacity:1}
.meta-btn{background:none;border:none;color:var(--text4);cursor:pointer;font-size:12px;padding:2px 6px;border-radius:4px;display:flex;align-items:center;gap:4px;font-family:inherit;transition:all var(--transition)}
.meta-btn:hover{background:var(--card-hover);color:var(--text3)}

/* ‚ïê‚ïê‚ïê Block Editor ‚ïê‚ïê‚ïê */
.block{display:flex;align-items:flex-start;gap:0;position:relative;border-radius:4px;transition:background 80ms}
.block:hover{background:var(--card)}
.block:hover .block-handle{opacity:1}
.block-handle{opacity:0;display:flex;align-items:center;gap:0;padding:3px 2px;cursor:grab;color:var(--text4);flex-shrink:0;transition:opacity var(--transition);margin-top:2px}
.block-handle:hover{color:var(--text3)}
.block-handle svg{width:14px;height:14px}
.block-add{cursor:pointer;border-radius:4px;padding:1px;transition:all var(--transition)}
.block-add:hover{background:var(--card-hover);color:var(--text)}
.block-drag{cursor:grab;border-radius:4px;padding:1px;transition:all var(--transition)}
.block-drag:hover{background:var(--card-hover)}
.block-content{flex:1;outline:none;min-height:1.6em;padding:3px 4px;word-break:break-word;min-width:0}
.block-content:empty::before{content:attr(data-placeholder);color:var(--text4)}
.block-content[contenteditable="true"]:focus{outline:none}

/* Block types */
.block[data-type="h1"] .block-content{font-size:30px;font-weight:700;line-height:1.2;padding-top:16px;padding-bottom:4px}
.block[data-type="h2"] .block-content{font-size:24px;font-weight:600;line-height:1.25;padding-top:12px;padding-bottom:2px;color:var(--text)}
.block[data-type="h3"] .block-content{font-size:20px;font-weight:600;line-height:1.3;padding-top:8px;color:var(--text)}
.block[data-type="quote"] .block-content{border-left:3px solid var(--text4);padding-left:14px;color:var(--text2);font-style:italic}
.block[data-type="callout"]{background:rgba(0,212,255,.06)!important;border-radius:6px;padding:12px 8px;margin:4px 0}
.block[data-type="callout"] .block-content{padding-left:8px}
.block[data-type="callout"] .callout-icon{font-size:20px;padding:0 4px;cursor:pointer}
.block[data-type="code"]{background:var(--bg2)!important;border:1px solid var(--border);border-radius:6px;margin:4px 0}
.block[data-type="code"] .block-content{font-family:'JetBrains Mono',monospace;font-size:13px;padding:12px;white-space:pre-wrap;color:var(--green)}
.block[data-type="divider"]{padding:8px 0}
.block[data-type="divider"] .block-content{height:1px;background:var(--border);min-height:1px;padding:0;cursor:default}
.block[data-type="todo"] .block-content{display:flex;align-items:flex-start;gap:8px}
.block[data-type="todo"] input[type="checkbox"]{margin-top:4px;accent-color:var(--cyan);width:16px;height:16px;cursor:pointer;flex-shrink:0}
.block[data-type="todo"] .todo-text{flex:1;outline:none;min-height:1.6em}
.block[data-type="todo"].checked .todo-text{text-decoration:line-through;color:var(--text4)}
.block[data-type="bullet"] .block-content::before{content:'‚Ä¢';color:var(--text3);margin-right:8px;font-weight:bold}
.block[data-type="numbered"] .block-content::before{content:attr(data-number) '.';color:var(--text3);margin-right:8px;min-width:18px;display:inline-block}
.block[data-type="toggle"] .toggle-arrow{cursor:pointer;transition:transform var(--transition);color:var(--text4);flex-shrink:0;padding:4px 2px}
.block[data-type="toggle"] .toggle-arrow.open{transform:rotate(90deg)}
.block[data-type="toggle"] .toggle-children{padding-left:24px}
.block[data-type="toggle"] .toggle-children.hidden{display:none}
.block[data-type="page_link"]{cursor:pointer}
.block[data-type="page_link"] .block-content{color:var(--cyan);display:flex;align-items:center;gap:6px}
.block[data-type="page_link"]:hover .block-content{text-decoration:underline}

/* Block indent */
.block[data-indent="1"]{margin-left:24px}
.block[data-indent="2"]{margin-left:48px}
.block[data-indent="3"]{margin-left:72px}

/* Drag indicator */
.block.drag-over-top{border-top:2px solid var(--cyan);margin-top:-2px}
.block.drag-over-bottom{border-bottom:2px solid var(--cyan);margin-bottom:-2px}
.block.dragging{opacity:.3}

/* ‚ïê‚ïê‚ïê Slash Menu ‚ïê‚ïê‚ïê */
#slash-menu{position:absolute;z-index:100;background:var(--bg3);border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 40px rgba(0,0,0,.5);width:280px;max-height:320px;overflow-y:auto;display:none;animation:menuIn 100ms ease-out;scrollbar-width:thin}
@keyframes menuIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
#slash-menu.open{display:block}
.slash-section{padding:6px 0}
.slash-section-title{font-size:11px;font-weight:500;color:var(--text4);padding:4px 12px;text-transform:uppercase;letter-spacing:.5px}
.slash-item{display:flex;align-items:center;gap:10px;padding:6px 12px;cursor:pointer;transition:background 80ms;border-radius:4px;margin:0 4px}
.slash-item:hover,.slash-item.focused{background:var(--card-hover)}
.slash-item .si-icon{width:36px;height:36px;border-radius:6px;background:var(--card);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--text2);flex-shrink:0}
.slash-item .si-info{flex:1;min-width:0}
.slash-item .si-name{font-size:13px;color:var(--text);font-weight:500}
.slash-item .si-desc{font-size:11px;color:var(--text4)}

/* ‚ïê‚ïê‚ïê Search Modal ‚ïê‚ïê‚ïê */
#search-modal{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);justify-content:center;padding-top:15vh}
#search-modal.open{display:flex}
.search-box{width:520px;max-height:55vh;background:var(--bg3);border:1px solid var(--border);border-radius:12px;box-shadow:0 24px 80px rgba(0,0,0,.6);overflow:hidden;display:flex;flex-direction:column;animation:menuIn 150ms ease-out}
.search-box input{width:100%;padding:14px 18px;border:none;background:none;color:var(--text);font-size:15px;outline:none;border-bottom:1px solid var(--border);font-family:inherit}
.search-box input::placeholder{color:var(--text4)}
.search-results{overflow-y:auto;flex:1;padding:4px}
.search-item{display:flex;align-items:center;gap:10px;padding:8px 14px;cursor:pointer;border-radius:6px;margin:2px;transition:background 80ms}
.search-item:hover,.search-item.focused{background:var(--card-hover)}
.search-item .si-icon{font-size:16px;width:20px;text-align:center}
.search-item .si-title{font-size:14px;color:var(--text)}
.search-item .si-snippet{font-size:12px;color:var(--text4);margin-top:1px}
.search-empty{padding:24px;text-align:center;color:var(--text4);font-size:13px}

/* ‚ïê‚ïê‚ïê Icon Picker ‚ïê‚ïê‚ïê */
#icon-picker{display:none;position:absolute;z-index:150;background:var(--bg3);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.5);padding:12px;width:340px;animation:menuIn 100ms ease-out}
.icon-cat-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;margin:10px 0 4px;padding:0 2px}
.icon-cat-label:first-child{margin-top:0}
#icon-picker.open{display:block}
.icon-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.icon-option{width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:8px;transition:background var(--transition);color:var(--text2)}
.icon-option:hover{background:var(--card-hover)}

/* ‚ïê‚ïê‚ïê Custom Dialog ‚ïê‚ïê‚ïê */
#dialog{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);justify-content:center;padding-top:25vh}
#dialog.open{display:flex}
.dialog-box{width:380px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;box-shadow:0 24px 80px rgba(0,0,0,.6);padding:24px;animation:menuIn 150ms ease-out}
.dialog-box h3{font-size:15px;font-weight:600;margin-bottom:8px}
.dialog-box p{font-size:13px;color:var(--text3);margin-bottom:16px}
.dialog-btns{display:flex;gap:8px;justify-content:flex-end}
.btn{padding:7px 14px;border-radius:6px;border:none;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;transition:all var(--transition)}
.btn-primary{background:var(--cyan);color:#0d0d0d}
.btn-primary:hover{opacity:.9}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{opacity:.9}
.btn-ghost{background:none;color:var(--text3)}
.btn-ghost:hover{background:var(--card-hover);color:var(--text)}

/* ‚ïê‚ïê‚ïê Empty / Welcome ‚ïê‚ïê‚ïê */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text4);gap:12px}
.welcome svg{width:48px;height:48px;opacity:.2}
.welcome p{font-size:14px}
.welcome .hint{font-size:12px;color:var(--text4)}

/* ‚ïê‚ïê‚ïê Inline Format Toolbar ‚ïê‚ïê‚ïê */
#format-bar{display:none;position:absolute;z-index:100;background:var(--bg3);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.4);padding:2px;flex-wrap:nowrap;gap:0}
#format-bar.open{display:flex}
.fmt-btn{padding:5px 8px;border:none;background:none;color:var(--text2);cursor:pointer;border-radius:4px;font-size:13px;font-family:inherit;font-weight:500;transition:all 80ms;display:flex;align-items:center}
.fmt-btn:hover{background:var(--card-hover);color:var(--text)}
.fmt-btn.active{color:var(--cyan)}
.fmt-sep{width:1px;background:var(--border);margin:4px 2px}

/* ‚ïê‚ïê‚ïê Workspace Tabs ‚ïê‚ïê‚ïê */
.ws-tabs{display:flex;gap:0;padding:4px 8px 0;border-bottom:1px solid var(--border);margin-bottom:4px}
.ws-tab{flex:1;padding:8px 4px;background:none;border:none;color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;transition:all var(--transition);display:flex;align-items:center;justify-content:center;gap:4px;font-family:inherit}
.ws-tab:hover{color:var(--text)}
.ws-tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.ws-content{display:none;flex-direction:column;flex:1;overflow:hidden}
.ws-content.active{display:flex}

/* ‚ïê‚ïê‚ïê Database Views ‚ïê‚ïê‚ïê */
.db-header{padding:40px 24px 20px;max-width:960px;margin:0 auto;width:100%}
.db-title{font-size:32px;font-weight:700;outline:none;border:none;background:none;color:var(--text);width:100%;font-family:inherit}
.db-title:empty::before{content:attr(placeholder);color:var(--text4)}
.db-desc{font-size:14px;color:var(--text3);margin-top:4px;outline:none}
.db-desc:empty::before{content:'Add a description...';color:var(--text4)}

/* View Tabs */
.view-tabs{display:flex;align-items:center;gap:0;border-bottom:1px solid var(--border);padding:0 24px;max-width:960px;margin:0 auto;width:100%}
.view-tab{padding:8px 16px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;font-weight:500;border-bottom:2px solid transparent;transition:all var(--transition);font-family:inherit;display:flex;align-items:center;gap:6px}
.view-tab:hover{color:var(--text)}
.view-tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.view-add{padding:6px;color:var(--text4);cursor:pointer;margin-left:4px;display:flex;align-items:center}
.view-add:hover{color:var(--text)}

/* Table View */
.db-table-wrap{max-width:960px;margin:0 auto;width:100%;padding:12px 24px;overflow-x:auto}
.db-table{width:100%;border-collapse:collapse;font-size:13px}
.db-table th{text-align:left;padding:6px 12px;color:var(--text3);font-weight:500;font-size:12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);user-select:none;white-space:nowrap}
.db-table td{padding:6px 12px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
.db-table tr:hover td{background:var(--card)}
.db-table tr{cursor:pointer}
.db-table .title-cell{font-weight:500;color:var(--text);display:flex;align-items:center;gap:6px}
.db-table .title-cell input{background:none;border:none;color:var(--text);font-size:13px;font-weight:500;outline:none;width:100%;font-family:inherit}
.db-table .new-row{color:var(--text4);cursor:pointer}
.db-table .new-row:hover{color:var(--text3)}
.db-table .new-row td{border:none}

/* Property Tags */
.prop-tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500;line-height:1.4}
.prop-multi{display:flex;gap:4px;flex-wrap:wrap}
.prop-date{color:var(--text2);font-size:12px}
.prop-text{color:var(--text2);font-size:12px}
.prop-checkbox{accent-color:var(--cyan)}
.prop-number{color:var(--text2);font-size:12px;font-variant-numeric:tabular-nums}

/* Board View (Kanban) */
.db-board{display:flex;gap:12px;padding:12px 24px;max-width:960px;margin:0 auto;width:100%;overflow-x:auto;flex:1}
.board-col{min-width:260px;width:260px;flex-shrink:0;display:flex;flex-direction:column;gap:8px}
.board-col-header{display:flex;align-items:center;gap:8px;padding:8px 4px;font-size:13px;font-weight:600}
.board-col-header .col-tag{padding:2px 8px;border-radius:4px;font-size:12px}
.board-col-header .col-count{color:var(--text4);font-size:12px;font-weight:400}
.board-cards{display:flex;flex-direction:column;gap:6px;flex:1;min-height:40px;padding:4px;border-radius:8px;transition:background var(--transition)}
.board-cards.drag-over{background:rgba(0,212,255,.05)}
.board-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;transition:all var(--transition)}
.board-card:hover{border-color:var(--border-hover);background:var(--card-hover)}
.board-card .card-title{font-size:13px;font-weight:500;margin-bottom:6px}
.board-card .card-props{display:flex;flex-wrap:wrap;gap:4px;font-size:11px}
.board-add{padding:6px 8px;color:var(--text4);cursor:pointer;font-size:13px;border-radius:6px;transition:all var(--transition);display:flex;align-items:center;gap:4px}
.board-add:hover{background:var(--card);color:var(--text3)}

/* List View */
.db-list{max-width:960px;margin:0 auto;width:100%;padding:12px 24px}
.list-item{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:6px;cursor:pointer;transition:background var(--transition)}
.list-item:hover{background:var(--card)}
.list-item .li-title{flex:1;font-size:14px;font-weight:500}
.list-item .li-props{display:flex;gap:8px;align-items:center}

/* Property Editor Modal */
#prop-editor{display:none;position:fixed;right:0;top:0;bottom:0;width:380px;z-index:200;background:var(--bg2);border-left:1px solid var(--border);box-shadow:-8px 0 32px rgba(0,0,0,.4);overflow-y:auto;animation:slideIn 150ms ease-out}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:none}}
#prop-editor.open{display:block}
.pe-header{display:flex;align-items:center;padding:16px;border-bottom:1px solid var(--border);gap:8px}
.pe-header h3{flex:1;font-size:15px;font-weight:600}
.pe-close{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:4px}
.pe-close:hover{color:var(--text);background:var(--card-hover)}
.pe-body{padding:16px}
.pe-field{margin-bottom:16px}
.pe-field label{display:block;font-size:12px;color:var(--text3);margin-bottom:4px;font-weight:500}
.pe-field input,.pe-field select,.pe-field textarea{width:100%;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;outline:none;font-family:inherit}
.pe-field input:focus,.pe-field select:focus{border-color:var(--cyan)}
.pe-select-opts{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.pe-select-opt{padding:3px 10px;border-radius:4px;cursor:pointer;font-size:12px;transition:all var(--transition);border:1px solid transparent}
.pe-select-opt:hover{border-color:var(--border-hover)}
.pe-select-opt.selected{border-color:var(--cyan)}

@media(max-width:768px){
  :root{--sidebar-w:100vw}
  #sidebar{position:fixed;top:0;left:0;bottom:0;z-index:50;transform:translateX(-100%);transition:transform 200ms}
  #sidebar:not(.collapsed){transform:translateX(0)}
}
</style>
</head>
<body>
<div id="app">
  <!-- ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê -->
  <aside id="sidebar">
    <div class="sb-header">
      <h1><i data-lucide="brain"></i> Brain Notes</h1>
      <button class="sb-btn" onclick="toggleSidebar()" title="Collapse"><i data-lucide="panel-left"></i></button>
    </div>
    <div class="sb-search">
      <i data-lucide="search"></i>
      <input type="text" placeholder="Search..." onkeydown="if(event.key==='Enter')openSearch(this.value)" onfocus="openSearch()">
    </div>
    <!-- Workspace Tabs -->
    <div class="ws-tabs">
      <button class="ws-tab active" data-ws="docs" onclick="switchWorkspace('docs')"><i data-lucide="file-text" style="width:14px;height:14px"></i> Docs</button>
      <button class="ws-tab" data-ws="projects" onclick="switchWorkspace('projects')"><i data-lucide="layout-grid" style="width:14px;height:14px"></i> Projects</button>
      <button class="ws-tab" data-ws="wiki" onclick="switchWorkspace('wiki')"><i data-lucide="book-open" style="width:14px;height:14px"></i> Wiki</button>
    </div>
    <!-- Docs workspace -->
    <div id="ws-docs" class="ws-content active">
      <div class="sb-section">
        <button class="sb-new-page" onclick="createPage()"><i data-lucide="plus" style="width:14px;height:14px"></i> New page</button>
      </div>
      <div class="sb-section">
        <div class="sb-section-title">Favorites</div>
        <div id="favorites-list"></div>
      </div>
      <div class="sb-section" style="flex:1;overflow-y:auto">
        <div class="sb-section-title">Pages</div>
        <div id="page-list" class="page-list"></div>
      </div>
    </div>
    <!-- Projects workspace -->
    <div id="ws-projects" class="ws-content">
      <div class="sb-section">
        <button class="sb-new-page" onclick="createDatabase('projects')"><i data-lucide="plus" style="width:14px;height:14px"></i> New project</button>
      </div>
      <div class="sb-section" style="flex:1;overflow-y:auto">
        <div id="project-list" class="page-list"></div>
      </div>
    </div>
    <!-- Wiki workspace -->
    <div id="ws-wiki" class="ws-content">
      <div class="sb-section">
        <button class="sb-new-page" onclick="createDatabase('wiki')"><i data-lucide="plus" style="width:14px;height:14px"></i> New knowledge base</button>
      </div>
      <div class="sb-section" style="flex:1;overflow-y:auto">
        <div id="wiki-list" class="page-list"></div>
      </div>
    </div>
  </aside>

  <!-- ‚ïê‚ïê‚ïê Main ‚ïê‚ïê‚ïê -->
  <div id="main">
    <div class="topbar">
      <button class="tb-btn" onclick="toggleSidebar()"><i data-lucide="panel-left"></i></button>
      <div class="breadcrumbs" id="breadcrumbs"></div>
      <button class="tb-btn" onclick="openSearch()" title="Search (‚åòK)"><i data-lucide="search"></i></button>
    </div>
    <div id="page-area">
      <div class="welcome" id="welcome">
        <i data-lucide="brain"></i>
        <p>Brain Notes</p>
        <div class="hint">Select a page or create a new one</div>
      </div>
    </div>
  </div>
</div>

<!-- Slash Menu -->
<div id="slash-menu"></div>

<!-- Search Modal -->
<div id="search-modal" onclick="if(event.target===this)closeSearch()">
  <div class="search-box">
    <input type="text" id="search-input" placeholder="Search pages and blocks..." oninput="doSearch(this.value)" onkeydown="searchKeys(event)">
    <div class="search-results" id="search-results"><div class="search-empty">Type to search</div></div>
  </div>
</div>

<!-- Icon Picker -->
<div id="icon-picker"></div>

<!-- Property Editor Side Panel -->
<div id="prop-editor">
  <div class="pe-header">
    <h3 id="pe-title">Edit Item</h3>
    <button class="pe-close" onclick="closePropEditor()"><i data-lucide="x" style="width:16px;height:16px"></i></button>
  </div>
  <div class="pe-body" id="pe-body"></div>
</div>

<!-- Format Bar -->
<div id="format-bar">
  <button class="fmt-btn" onmousedown="execFmt(event,'bold')"><b>B</b></button>
  <button class="fmt-btn" onmousedown="execFmt(event,'italic')"><i>i</i></button>
  <button class="fmt-btn" onmousedown="execFmt(event,'underline')"><u>U</u></button>
  <button class="fmt-btn" onmousedown="execFmt(event,'strikeThrough')"><s>S</s></button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" onmousedown="execFmt(event,'code')"><code style="font-size:12px;font-family:'JetBrains Mono',monospace">&lt;/&gt;</code></button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" onmousedown="execFmt(event,'link')">üîó</button>
</div>

<!-- Dialog -->
<div id="dialog" onclick="if(event.target===this)closeDialog(null)">
  <div class="dialog-box">
    <h3 id="dialog-title"></h3>
    <p id="dialog-msg"></p>
    <div class="dialog-btns">
      <button class="btn btn-ghost" onclick="closeDialog(null)">Cancel</button>
      <button class="btn btn-danger" id="dialog-ok" onclick="closeDialog(true)">Delete</button>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BRAIN NOTES ‚Äî Notion Clone
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let pages = [];
let currentPage = null;
let currentBlocks = [];
let slashBlock = null;
let slashIdx = -1;
let searchIdx = -1;
let dialogCb = null;

const api = (path, opts={}) => fetch('/api'+path, {
  headers:{'Content-Type':'application/json'}, ...opts,
  body: opts.body ? JSON.stringify(opts.body) : undefined
}).then(r=>r.json());

const ICON_CATEGORIES = {
  'Documents': ['file-text','file','file-check','file-plus','file-minus','file-search','files','clipboard','clipboard-list','clipboard-check','notebook','book-open','book','bookmark','scroll'],
  'Work': ['briefcase','building-2','presentation','bar-chart-3','bar-chart-2','pie-chart','trending-up','trending-down','calculator','paperclip','pen-tool','ruler','table','kanban','layout-grid'],
  'Tech': ['monitor','laptop','server','database','hard-drive','cpu','wifi','globe','smartphone','terminal','code','code-2','git-branch','git-merge','bug'],
  'Science': ['flask-conical','microscope','dna','atom','beaker','brain','heart-pulse','pill','stethoscope','thermometer','scan','activity','zap','binary','circuit-board'],
  'Creative': ['palette','brush','pen','camera','film','video','music','headphones','mic','image','aperture','figma','sparkles','wand-2','layers'],
  'Education': ['graduation-cap','library','school','lamp','lightbulb','search','book-marked','languages','message-circle','megaphone','users','user','eye','compass','map'],
  'Planning': ['target','check-circle','circle-dot','calendar','calendar-check','clock','alarm-clock','timer','list-todo','list-checks','flag','milestone','route','signpost','map-pin'],
  'Finance': ['wallet','credit-card','banknote','landmark','gem','package','shopping-cart','store','coins','receipt','arrow-up-circle','arrow-down-circle','piggy-bank','gift','trophy'],
  'Nature': ['sprout','leaf','trees','flower-2','sun','moon','cloud','cloud-rain','snowflake','flame','wind','waves','mountain','rainbow','star'],
  'Symbols': ['rocket','shield','sword','key','lock','unlock','heart','circle','square','triangle','hexagon','octagon','infinity','hash','at-sign']
};
const ICONS = Object.values(ICON_CATEGORIES).flat();
function renderIcon(name, size=18){
  if(!name) return '<i data-lucide="file-text" style="width:'+size+'px;height:'+size+'px;color:var(--text3)"></i>';
  // Legacy emoji check ‚Äî if it's not a lucide name, show as text
  if(name.length <= 2 || /[\u{1F000}-\u{1FFFF}]/u.test(name)) return `<span style="font-size:${size}px;line-height:1">${name}</span>`;
  return `<i data-lucide="${name}" style="width:${size}px;height:${size}px"></i>`;
}

const BLOCK_TYPES = [
  {section:'Basic', items:[
    {type:'text',icon:'T',name:'Text',desc:'Plain text block'},
    {type:'h1',icon:'H‚ÇÅ',name:'Heading 1',desc:'Large heading'},
    {type:'h2',icon:'H‚ÇÇ',name:'Heading 2',desc:'Medium heading'},
    {type:'h3',icon:'H‚ÇÉ',name:'Heading 3',desc:'Small heading'},
    {type:'bullet',icon:'‚Ä¢',name:'Bullet List',desc:'Simple bullet list'},
    {type:'numbered',icon:'1.',name:'Numbered List',desc:'Numbered list'},
    {type:'todo',icon:'‚òë',name:'To-do',desc:'Track tasks with checkboxes'},
    {type:'toggle',icon:'‚ñ∂',name:'Toggle',desc:'Collapsible content'},
  ]},
  {section:'Media & Advanced', items:[
    {type:'quote',icon:'‚ùù',name:'Quote',desc:'Capture a quote'},
    {type:'callout',icon:'üí°',name:'Callout',desc:'Highlighted info block'},
    {type:'code',icon:'</>',name:'Code',desc:'Code snippet'},
    {type:'divider',icon:'‚Äî',name:'Divider',desc:'Visual separator'},
    {type:'page_link',icon:'‚Üó',name:'Page Link',desc:'Link to another page'},
  ]},
];

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
(async function boot(){
  try {
    await refreshPages();
    setupKeys();
    lucide.createIcons();
  } catch(e){ console.error('Boot:',e); }
})();

// ‚îÄ‚îÄ Pages ‚îÄ‚îÄ
async function refreshPages(){
  pages = await api('/pages');
  renderSidebar();
}

function renderSidebar(){
  const roots = pages.filter(p => !p.parent_id);
  const favs = pages.filter(p => p.is_favorite);
  
  document.getElementById('favorites-list').innerHTML = favs.length
    ? favs.map(p => pageItemHTML(p)).join('')
    : '<div style="padding:4px 8px;font-size:12px;color:var(--text4)">No favorites</div>';
  
  document.getElementById('page-list').innerHTML = roots.length
    ? roots.map(p => pageTreeHTML(p)).join('')
    : '';
  
  lucide.createIcons();
}

function pageItemHTML(p){
  const active = currentPage && currentPage.id === p.id ? ' active' : '';
  return `<div class="page-item${active}" onclick="loadPage('${p.id}')" oncontextmenu="pageMenu(event,'${p.id}')">
    <span class="p-icon">${renderIcon(p.icon,16)}</span>
    <span class="p-title">${esc(p.title)}</span>
  </div>`;
}

function pageTreeHTML(p){
  const children = pages.filter(c => c.parent_id === p.id);
  const active = currentPage && currentPage.id === p.id ? ' active' : '';
  const hasKids = children.length > 0;
  let html = `<div class="page-tree-node">
    <div class="page-item${active}" onclick="loadPage('${p.id}')" oncontextmenu="pageMenu(event,'${p.id}')">
      ${hasKids ? `<span class="p-toggle" onclick="event.stopPropagation();toggleChildren(this)"><i data-lucide="chevron-right" style="width:12px;height:12px"></i></span>` : '<span style="width:12px"></span>'}
      <span class="p-icon">${renderIcon(p.icon,16)}</span>
      <span class="p-title">${esc(p.title)}</span>
      <span class="p-add" onclick="event.stopPropagation();createPage('${p.id}')"><i data-lucide="plus" style="width:12px;height:12px"></i></span>
    </div>`;
  if (hasKids){
    html += `<div class="page-children">${children.map(c=>pageTreeHTML(c)).join('')}</div>`;
  }
  return html + '</div>';
}

function toggleChildren(el){
  const node = el.closest('.page-tree-node');
  const kids = node.querySelector('.page-children');
  if(kids) kids.classList.toggle('collapsed');
  const icon = el.querySelector('svg');
  if(icon) icon.style.transform = kids?.classList.contains('collapsed') ? '' : 'rotate(90deg)';
}

async function createPage(parentId){
  const page = await api('/pages', {method:'POST', body:{title:'Untitled', parent_id:parentId||null, icon:'üìù'}});
  await refreshPages();
  await loadPage(page.id);
}

async function loadPage(id){
  const data = await api('/pages/'+id);
  currentPage = data;
  currentBlocks = data.blocks || [];
  renderPage();
  renderSidebar();
  const w = document.getElementById('welcome');
  if(w) w.style.display = 'none';
}

function renderPage(){
  if(!currentPage) return;
  const area = document.getElementById('page-area');
  
  let breadcrumbs = buildBreadcrumbs(currentPage);
  document.getElementById('breadcrumbs').innerHTML = breadcrumbs;
  
  let html = '<div class="page-content">';
  
  // Header
  html += `<div class="page-header">
    <div class="page-icon" onclick="openIconPicker(this,'${currentPage.id}')">${renderIcon(currentPage.icon,40)}</div>
    <div class="page-title" contenteditable="true" placeholder="Untitled" data-page-id="${currentPage.id}"
      oninput="onTitleChange(this)" onkeydown="if(event.key==='Enter'){event.preventDefault();focusFirstBlock()}">${esc(currentPage.title)}</div>
    <div class="page-header-actions">
      <button class="meta-btn" onclick="openIconPicker(document.querySelector('.page-icon'),'${currentPage.id}')"><i data-lucide="smile" style="width:12px;height:12px"></i> Icon</button>
    </div>
  </div>`;
  
  // Blocks
  html += '<div id="blocks-container">';
  let bulletNum = 0;
  currentBlocks.forEach((b,i) => {
    if(b.type === 'numbered') bulletNum++; else bulletNum = 0;
    html += blockHTML(b, i, bulletNum);
  });
  html += '</div>';
  
  // Click to add
  html += `<div style="min-height:200px;cursor:text" onclick="addBlockAtEnd()"></div>`;
  html += '</div>';
  
  area.innerHTML = html;
  lucide.createIcons();
  setupBlockListeners();
}

function blockHTML(b, i, num){
  const indent = b.indent_level || 0;
  const props = typeof b.properties === 'string' ? JSON.parse(b.properties || '{}') : (b.properties || {});
  
  if(b.type === 'todo'){
    const checked = props.checked ? ' checked' : '';
    return `<div class="block${props.checked?' checked':''}" data-id="${b.id}" data-type="todo" data-indent="${indent}">
      <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
      <div class="block-content"><input type="checkbox"${checked} onchange="toggleTodo('${b.id}',this.checked)"><div class="todo-text" contenteditable="true" data-block-id="${b.id}" data-placeholder="To-do">${esc(b.content)}</div></div>
    </div>`;
  }
  
  if(b.type === 'divider'){
    return `<div class="block" data-id="${b.id}" data-type="divider" data-indent="${indent}">
      <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
      <div class="block-content"></div>
    </div>`;
  }
  
  if(b.type === 'callout'){
    const icon = props.icon || 'üí°';
    return `<div class="block" data-id="${b.id}" data-type="callout" data-indent="${indent}">
      <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
      <span class="callout-icon">${icon}</span>
      <div class="block-content" contenteditable="true" data-block-id="${b.id}" data-placeholder="Type something...">${esc(b.content)}</div>
    </div>`;
  }
  
  if(b.type === 'page_link'){
    return `<div class="block" data-id="${b.id}" data-type="page_link" data-indent="${indent}" onclick="loadPage('${b.content}')">
      <div class="block-handle"><span class="block-add" onclick="event.stopPropagation();addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span></div>
      <div class="block-content"><i data-lucide="file-text" style="width:14px;height:14px"></i> ${esc(props.title||b.content)}</div>
    </div>`;
  }
  
  const ph = b.type==='h1'?'Heading 1':b.type==='h2'?'Heading 2':b.type==='h3'?'Heading 3':
    b.type==='quote'?'Quote':b.type==='code'?'Code':b.type==='bullet'?'List':
    b.type==='numbered'?'List':"Type '/' for commands";
  
  return `<div class="block" data-id="${b.id}" data-type="${b.type}" data-indent="${indent}">
    <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
    <div class="block-content" contenteditable="true" data-block-id="${b.id}" data-placeholder="${ph}"${b.type==='numbered'?' data-number="'+num+'"':''}>${esc(b.content)}</div>
  </div>`;
}

function setupBlockListeners(){
  // Click anywhere on block ‚Üí focus the contenteditable
  document.querySelectorAll('.block').forEach(block => {
    block.addEventListener('click', e => {
      if(e.target.closest('.block-handle') || e.target.closest('input[type="checkbox"]')) return;
      const editable = block.querySelector('[data-block-id]') || block.querySelector('.todo-text');
      if(editable && document.activeElement !== editable) { editable.focus(); }
    });
  });
  document.querySelectorAll('[data-block-id]').forEach(el => {
    el.addEventListener('input', () => saveBlock(el.dataset.blockId, el.innerText));
    el.addEventListener('keydown', e => blockKeyDown(e, el));
    el.addEventListener('blur', () => {
      // Flush any pending save immediately on blur
      const bid = el.dataset.blockId;
      if(saveTimers[bid]){ clearTimeout(saveTimers[bid]); saveTimers[bid]=null; }
      const b = currentBlocks.find(b=>b.id===bid);
      if(b && b.content !== el.innerText){ b.content = el.innerText; api('/blocks/'+bid, {method:'PUT', body:{content:el.innerText}}); }
    });
  });
  // Todo text fields also need save + keydown
  document.querySelectorAll('.todo-text[data-block-id]').forEach(el => {
    el.addEventListener('input', () => saveBlock(el.dataset.blockId, el.innerText));
    el.addEventListener('keydown', e => blockKeyDown(e, el));
    el.addEventListener('blur', () => {
      const bid = el.dataset.blockId;
      if(saveTimers[bid]){ clearTimeout(saveTimers[bid]); saveTimers[bid]=null; }
      const b = currentBlocks.find(b=>b.id===bid);
      if(b && b.content !== el.innerText){ b.content = el.innerText; api('/blocks/'+bid, {method:'PUT', body:{content:el.innerText}}); }
    });
  });
  // Drag & drop reorder
  let dragBlockId = null;
  document.querySelectorAll('.block-drag').forEach(handle => {
    handle.addEventListener('dragstart', e => {
      dragBlockId = handle.closest('.block').dataset.id;
      handle.closest('.block').classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    handle.addEventListener('dragend', () => {
      document.querySelectorAll('.block').forEach(b => b.classList.remove('dragging','drag-over-top','drag-over-bottom'));
      dragBlockId = null;
    });
  });
  document.querySelectorAll('.block').forEach(block => {
    block.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const rect = block.getBoundingClientRect();
      const mid = rect.top + rect.height / 2;
      document.querySelectorAll('.block').forEach(b => b.classList.remove('drag-over-top','drag-over-bottom'));
      block.classList.add(e.clientY < mid ? 'drag-over-top' : 'drag-over-bottom');
    });
    block.addEventListener('dragleave', () => {
      block.classList.remove('drag-over-top','drag-over-bottom');
    });
    block.addEventListener('drop', e => {
      e.preventDefault();
      document.querySelectorAll('.block').forEach(b => b.classList.remove('drag-over-top','drag-over-bottom'));
      const targetId = block.dataset.id;
      if(!dragBlockId || !targetId || dragBlockId === targetId) return;
      const rect = block.getBoundingClientRect();
      const above = e.clientY < rect.top + rect.height / 2;
      // Reorder in local state
      const dragIdx = currentBlocks.findIndex(b => b.id === dragBlockId);
      const [moved] = currentBlocks.splice(dragIdx, 1);
      let targetIdx = currentBlocks.findIndex(b => b.id === targetId);
      if(!above) targetIdx++;
      currentBlocks.splice(targetIdx, 0, moved);
      // Save new order
      const order = currentBlocks.map(b => b.id);
      api('/pages/'+currentPage.id+'/blocks/reorder', {method:'PUT', body:{order}});
      renderPage();
    });
  });
  // Format bar on selection
  document.addEventListener('selectionchange', showFormatBar);
}

// ‚îÄ‚îÄ Block Operations ‚îÄ‚îÄ
let saveTimers = {};
function saveBlock(id, content){
  clearTimeout(saveTimers[id]);
  // Update local state immediately
  const b = currentBlocks.find(b=>b.id===id);
  if(b) b.content = content;
  saveTimers[id] = setTimeout(() => {
    api('/blocks/'+id, {method:'PUT', body:{content}}).catch(e => console.error('Save failed:', e));
  }, 500);
}

function blockKeyDown(e, el){
  const bid = el.dataset.blockId;
  
  // If slash menu is open, handle keys there first
  if(document.getElementById('slash-menu').classList.contains('open')){
    if(e.key === 'ArrowDown'){e.preventDefault();slashIdx++;renderSlashMenu(el.innerText);return;}
    if(e.key === 'ArrowUp'){e.preventDefault();slashIdx=Math.max(0,slashIdx-1);renderSlashMenu(el.innerText);return;}
    if(e.key === 'Enter'){
      e.preventDefault();
      const item = document.querySelector('.slash-item.focused');
      if(item) selectSlashItem(item.dataset.type);
      return;
    }
    if(e.key === 'Escape'){
      e.preventDefault();hideSlashMenu();el.innerText='';
      const b=currentBlocks.find(b=>b.id===bid);if(b)b.content='';
      api('/blocks/'+bid,{method:'PUT',body:{content:''}});
      return;
    }
    // Let other keys through for filtering
    return;
  }
  
  // Slash command ‚Äî don't preventDefault, let '/' be typed for filtering
  if(e.key === '/' && el.innerText === ''){
    setTimeout(() => showSlashMenu(el, bid), 10);
    return;
  }
  
  // Enter ‚Äî new block
  if(e.key === 'Enter' && !e.shiftKey){
    const block = currentBlocks.find(b=>b.id===bid);
    if(block && (block.type==='code')) return; // allow newlines in code
    e.preventDefault();
    // If in a list, continue list type
    const newType = (block && ['bullet','numbered','todo'].includes(block.type) && el.innerText.trim() !== '') ? block.type : 'text';
    // If empty list item, convert to text
    if(block && ['bullet','numbered','todo'].includes(block.type) && el.innerText.trim() === ''){
      api('/blocks/'+bid, {method:'PUT', body:{type:'text'}});
      block.type = 'text';
      renderPage();
      focusBlock(bid);
      return;
    }
    addBlockAfter(bid, newType);
    return;
  }
  
  // Backspace on empty ‚Äî delete block
  if(e.key === 'Backspace' && el.innerText.trim() === ''){
    e.preventDefault();
    const idx = currentBlocks.findIndex(b=>b.id===bid);
    if(idx > 0){
      const prevId = currentBlocks[idx-1].id;
      deleteBlock(bid, prevId, true);
    } else if(currentBlocks.length > 1){
      const nextId = currentBlocks[1]?.id;
      deleteBlock(bid, nextId, false);
    }
    return;
  }
  
  // Tab ‚Äî indent
  if(e.key === 'Tab'){
    e.preventDefault();
    const block = currentBlocks.find(b=>b.id===bid);
    if(!block) return;
    const newIndent = e.shiftKey ? Math.max(0, (block.indent_level||0)-1) : Math.min(3, (block.indent_level||0)+1);
    block.indent_level = newIndent;
    api('/blocks/'+bid, {method:'PUT', body:{indent_level:newIndent}});
    const blockEl = document.querySelector(`.block[data-id="${bid}"]`);
    if(blockEl) blockEl.dataset.indent = newIndent;
    return;
  }
  
  // Arrow up/down ‚Äî navigate blocks
  if(e.key === 'ArrowUp'){
    const idx = currentBlocks.findIndex(b=>b.id===bid);
    if(idx > 0){ e.preventDefault(); focusBlock(currentBlocks[idx-1].id, true); }
  }
  if(e.key === 'ArrowDown'){
    const idx = currentBlocks.findIndex(b=>b.id===bid);
    if(idx < currentBlocks.length-1){ e.preventDefault(); focusBlock(currentBlocks[idx+1].id); }
  }
}

async function addBlockAfter(afterId, type='text'){
  const newId = Math.random().toString(36).substr(2,8);
  const block = {id:newId, page_id:currentPage.id, type, content:'', properties:'{}', indent_level:0};
  const idx = currentBlocks.findIndex(b=>b.id===afterId);
  currentBlocks.splice(idx+1, 0, block);
  await api('/pages/'+currentPage.id+'/blocks', {method:'POST', body:{id:newId, type, after_id:afterId}});
  renderPage();
  setTimeout(() => focusBlock(newId), 20);
}

async function addBlockAtEnd(){
  const lastBlock = currentBlocks[currentBlocks.length-1];
  if(lastBlock && lastBlock.content === '') { focusBlock(lastBlock.id); return; }
  const newId = Math.random().toString(36).substr(2,8);
  const block = {id:newId, page_id:currentPage.id, type:'text', content:'', properties:'{}', indent_level:0};
  currentBlocks.push(block);
  await api('/pages/'+currentPage.id+'/blocks', {method:'POST', body:{id:newId, type:'text'}});
  renderPage();
  setTimeout(() => focusBlock(newId), 20);
}

async function deleteBlock(id, focusId, atEnd){
  currentBlocks = currentBlocks.filter(b=>b.id!==id);
  api('/blocks/'+id, {method:'DELETE'});
  renderPage();
  if(focusId) setTimeout(() => focusBlock(focusId, atEnd), 20);
}

function focusBlock(id, atEnd){
  const el = document.querySelector(`[data-block-id="${id}"]`) || document.querySelector(`.todo-text[data-block-id="${id}"]`);
  if(!el) return;
  el.focus();
  if(atEnd && el.innerText.length){
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

function focusFirstBlock(){
  if(currentBlocks.length) focusBlock(currentBlocks[0].id);
}

async function toggleTodo(id, checked){
  const block = currentBlocks.find(b=>b.id===id);
  if(!block) return;
  const props = typeof block.properties === 'string' ? JSON.parse(block.properties||'{}') : (block.properties||{});
  props.checked = checked;
  block.properties = props;
  await api('/blocks/'+id, {method:'PUT', body:{properties:props}});
  const el = document.querySelector(`.block[data-id="${id}"]`);
  if(el) el.classList.toggle('checked', checked);
}

// ‚îÄ‚îÄ Slash Menu ‚îÄ‚îÄ
let slashEl = null;
function showSlashMenu(el, blockId){
  slashBlock = blockId;
  slashEl = el;
  slashIdx = 0;
  const menu = document.getElementById('slash-menu');
  const rect = el.getBoundingClientRect();
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 4) + 'px';
  renderSlashMenu('');
  menu.classList.add('open');
  el.addEventListener('input', slashFilter);
}

function hideSlashMenu(){
  const menu = document.getElementById('slash-menu');
  menu.classList.remove('open');
  if(slashEl) { slashEl.removeEventListener('input', slashFilter); slashEl = null; }
  slashBlock = null;
}

function renderSlashMenu(filter){
  const menu = document.getElementById('slash-menu');
  const fl = filter.toLowerCase().replace('/','');
  let html = '';
  let idx = 0;
  BLOCK_TYPES.forEach(section => {
    const items = section.items.filter(i => !fl || i.name.toLowerCase().includes(fl) || i.type.includes(fl));
    if(!items.length) return;
    html += `<div class="slash-section"><div class="slash-section-title">${section.section}</div>`;
    items.forEach(item => {
      html += `<div class="slash-item${idx===slashIdx?' focused':''}" data-idx="${idx}" data-type="${item.type}" 
        onmousedown="event.preventDefault();selectSlashItem('${item.type}')" onmouseenter="slashIdx=${idx};document.querySelectorAll('.slash-item').forEach((el,i)=>el.classList.toggle('focused',i===${idx}))">
        <div class="si-icon">${item.icon}</div>
        <div class="si-info"><div class="si-name">${item.name}</div><div class="si-desc">${item.desc}</div></div>
      </div>`;
      idx++;
    });
    html += '</div>';
  });
  if(!html) html = '<div class="search-empty">No matching blocks</div>';
  menu.innerHTML = html;
}

function slashFilter(e){
  const text = e.target.innerText;
  if(!text.startsWith('/')){hideSlashMenu();return;}
  slashIdx = 0;
  renderSlashMenu(text);
}

function slashKeys(e){
  if(!document.getElementById('slash-menu').classList.contains('open')) return;
  if(e.key === 'ArrowDown'){e.preventDefault();slashIdx++;renderSlashMenu('');}
  if(e.key === 'ArrowUp'){e.preventDefault();slashIdx=Math.max(0,slashIdx-1);renderSlashMenu('');}
  if(e.key === 'Enter'){
    e.preventDefault();
    const item = document.querySelector('.slash-item.focused');
    if(item) selectSlashItem(item.dataset.type);
  }
  if(e.key === 'Escape'){e.preventDefault();hideSlashMenu();e.target.innerText='';}
}

async function selectSlashItem(type){
  const bid = slashBlock;
  hideSlashMenu();
  if(!bid) return;
  const block = currentBlocks.find(b=>b.id===bid);
  if(!block) return;
  
  // Clear content in local state FIRST
  block.content = '';
  block.type = type;
  
  if(type === 'page_link'){
    const newPage = await api('/pages', {method:'POST', body:{title:'Untitled', parent_id:currentPage.id}});
    block.content = newPage.id;
    block.properties = JSON.stringify({title:newPage.title});
    await api('/blocks/'+block.id, {method:'PUT', body:{type:'page_link', content:newPage.id, properties:{title:newPage.title}}});
    await refreshPages();
    renderPage();
    return;
  }
  
  // Render immediately with cleared state, then save to API
  renderPage();
  setTimeout(() => focusBlock(block.id), 20);
  api('/blocks/'+block.id, {method:'PUT', body:{type, content:''}});
}

// ‚îÄ‚îÄ Title ‚îÄ‚îÄ
let titleTimer;
function onTitleChange(el){
  clearTimeout(titleTimer);
  titleTimer = setTimeout(async () => {
    const title = el.innerText.trim() || 'Untitled';
    currentPage.title = title;
    await api('/pages/'+currentPage.id, {method:'PUT', body:{title}});
    await refreshPages();
  }, 500);
}

// ‚îÄ‚îÄ Icon Picker ‚îÄ‚îÄ
function openIconPicker(el, pageId){
  const picker = document.getElementById('icon-picker');
  const rect = el.getBoundingClientRect();
  picker.style.left = rect.left + 'px';
  picker.style.top = (rect.bottom + 4) + 'px';
  function iconSvg(name, size=22){ return `<i data-lucide="${name}" style="width:${size}px;height:${size}px"></i>`; }
  function renderIconGrid(icons, pageId){
    return icons.map(i => `<div class="icon-option" onmousedown="event.preventDefault();selectIcon('${pageId}','${i}')" title="${i}">${iconSvg(i,20)}</div>`).join('');
  }
  const cats = Object.entries(ICON_CATEGORIES).map(([cat,icons]) => 
    `<div class="icon-cat-label">${cat}</div><div class="icon-grid">${renderIconGrid(icons, pageId)}</div>`
  ).join('');
  picker.innerHTML = `<input type="text" id="icon-search" placeholder="Search icons‚Ä¶" style="width:100%;padding:8px 10px;margin-bottom:8px;background:var(--bg1);border:1px solid var(--border);border-radius:8px;color:var(--text1);font-size:13px;outline:none">
    <div id="icon-cats" style="max-height:320px;overflow-y:auto;scrollbar-width:thin">${cats}</div>
    <button class="btn btn-ghost" style="margin-top:8px;width:100%;font-size:12px" onmousedown="event.preventDefault();selectIcon('${pageId}','')">Remove icon</button>`;
  lucide.createIcons({attrs:{'stroke-width':1.75}});
  picker.querySelector('#icon-search').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    const cont = picker.querySelector('#icon-cats');
    if(!q){ cont.innerHTML = cats; lucide.createIcons({attrs:{'stroke-width':1.75}}); return; }
    const matched = ICONS.filter(ic => ic.toLowerCase().includes(q) || 
      Object.entries(ICON_CATEGORIES).find(([k,v])=>v.includes(ic))?.[0]?.toLowerCase().includes(q));
    cont.innerHTML = `<div class="icon-grid">${renderIconGrid(matched, pageId)}</div>`;
    lucide.createIcons({attrs:{'stroke-width':1.75}});
  });
  picker.querySelector('#icon-search').focus();
  picker.classList.add('open');
  setTimeout(() => document.addEventListener('click', closeIconPicker), 10);
}

function closeIconPicker(e){
  const picker = document.getElementById('icon-picker');
  if(!picker.contains(e?.target)){
    picker.classList.remove('open');
    document.removeEventListener('click', closeIconPicker);
  }
}

async function selectIcon(pageId, icon){
  document.getElementById('icon-picker').classList.remove('open');
  document.removeEventListener('click', closeIconPicker);
  await api('/pages/'+pageId, {method:'PUT', body:{icon}});
  currentPage.icon = icon;
  await refreshPages();
  renderPage();
}

// ‚îÄ‚îÄ Breadcrumbs ‚îÄ‚îÄ
function buildBreadcrumbs(page){
  const chain = [];
  let p = page;
  while(p){
    chain.unshift(p);
    p = p.parent_id ? pages.find(x=>x.id===p.parent_id) : null;
  }
  return chain.map((c,i) => {
    if(i === chain.length-1) return `<span class="current">${renderIcon(c.icon,16)} ${esc(c.title)}</span>`;
    return `<span onclick="loadPage('${c.id}')">${renderIcon(c.icon,16)} ${esc(c.title)}</span><span class="sep">/</span>`;
  }).join('');
}

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ
function openSearch(initial){
  document.getElementById('search-modal').classList.add('open');
  const input = document.getElementById('search-input');
  input.value = typeof initial === 'string' ? initial : '';
  input.focus();
  if(initial) doSearch(initial);
}

function closeSearch(){
  document.getElementById('search-modal').classList.remove('open');
}

const debounce = (fn,ms) => {let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

async function doSearch(q){
  const el = document.getElementById('search-results');
  if(!q.trim()){el.innerHTML='<div class="search-empty">Type to search</div>';return;}
  const results = await api('/search?q='+encodeURIComponent(q));
  searchIdx = -1;
  if(!results.length){el.innerHTML='<div class="search-empty">No results</div>';return;}
  el.innerHTML = results.map((r,i) => `<div class="search-item${i===searchIdx?' focused':''}" data-id="${r.page_id}" onclick="closeSearch();loadPage('${r.page_id}')">
    <span class="si-icon">${renderIcon(r.icon,16)}</span>
    <div><div class="si-title">${esc(r.title)}</div>${r.snippet?`<div class="si-snippet">${esc(r.snippet)}</div>`:''}</div>
  </div>`).join('');
  lucide.createIcons();
}

function searchKeys(e){
  const items = document.querySelectorAll('.search-item');
  if(e.key==='ArrowDown'){e.preventDefault();searchIdx=Math.min(searchIdx+1,items.length-1);highlightSearch(items);}
  if(e.key==='ArrowUp'){e.preventDefault();searchIdx=Math.max(searchIdx-1,0);highlightSearch(items);}
  if(e.key==='Enter'&&searchIdx>=0&&items[searchIdx]){closeSearch();loadPage(items[searchIdx].dataset.id);}
  if(e.key==='Escape')closeSearch();
}

function highlightSearch(items){
  items.forEach((el,i)=>el.classList.toggle('focused',i===searchIdx));
  if(items[searchIdx])items[searchIdx].scrollIntoView({block:'nearest'});
}

// ‚îÄ‚îÄ Format Bar ‚îÄ‚îÄ
function showFormatBar(){
  const sel = window.getSelection();
  const bar = document.getElementById('format-bar');
  if(!sel.rangeCount || sel.isCollapsed || !sel.anchorNode?.closest?.('[data-block-id]')){
    bar.classList.remove('open');return;
  }
  const range = sel.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  bar.style.left = (rect.left + rect.width/2 - 100) + 'px';
  bar.style.top = (rect.top - 40) + 'px';
  bar.classList.add('open');
}

function execFmt(e, cmd){
  e.preventDefault();
  if(cmd==='code'){
    const sel=window.getSelection();
    if(sel.rangeCount){
      const range=sel.getRangeAt(0);
      const code=document.createElement('code');
      code.style.cssText='background:rgba(0,212,255,.08);padding:1px 4px;border-radius:3px;font-family:"JetBrains Mono",monospace;font-size:.9em';
      range.surroundContents(code);
    }
  } else if(cmd==='link'){
    const url = prompt('Enter URL:');
    if(url) document.execCommand('createLink', false, url);
  } else {
    document.execCommand(cmd);
  }
}

// ‚îÄ‚îÄ Page Menu ‚îÄ‚îÄ
function pageMenu(e, id){
  e.preventDefault();
  e.stopPropagation();
  const page = pages.find(p=>p.id===id);
  if(!page) return;
  
  // Simple context menu using dialog
  const items = [
    {label: page.is_favorite ? 'Remove from favorites' : 'Add to favorites', action: () => toggleFav(id)},
    {label: 'Rename', action: () => renamePage(id)},
    {label: 'Delete', action: () => deletePage(id), danger: true},
  ];
  
  // Use a quick inline menu
  const menu = document.createElement('div');
  menu.style.cssText = `position:fixed;left:${e.clientX}px;top:${e.clientY}px;z-index:200;background:var(--bg3);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5);padding:4px;min-width:160px;animation:menuIn 100ms ease-out`;
  items.forEach(item => {
    const el = document.createElement('div');
    el.style.cssText = `padding:6px 12px;border-radius:4px;cursor:pointer;font-size:13px;color:${item.danger?'var(--red)':'var(--text2)'};transition:background 80ms`;
    el.textContent = item.label;
    el.onmouseover = () => el.style.background = 'var(--card-hover)';
    el.onmouseout = () => el.style.background = 'none';
    el.onclick = () => { document.body.removeChild(menu); item.action(); };
    menu.appendChild(el);
  });
  document.body.appendChild(menu);
  setTimeout(() => document.addEventListener('click', function rm(){ document.body.contains(menu) && document.body.removeChild(menu); document.removeEventListener('click',rm); }), 10);
}

async function toggleFav(id){
  const page = pages.find(p=>p.id===id);
  if(!page) return;
  await api('/pages/'+id, {method:'PUT', body:{is_favorite: page.is_favorite ? 0 : 1}});
  await refreshPages();
}

async function renamePage(id){
  const page = pages.find(p=>p.id===id);
  if(!page) return;
  const title = prompt('New title:', page.title);
  if(!title) return;
  await api('/pages/'+id, {method:'PUT', body:{title}});
  if(currentPage && currentPage.id === id) currentPage.title = title;
  await refreshPages();
  if(currentPage && currentPage.id === id) renderPage();
}

async function deletePage(id){
  if(!confirm('Delete this page and all sub-pages?')) return;
  await api('/pages/'+id, {method:'DELETE'});
  if(currentPage && currentPage.id === id){
    currentPage = null;
    document.getElementById('page-area').innerHTML = '<div class="welcome" id="welcome"><i data-lucide="brain"></i><p>Brain Notes</p><div class="hint">Select a page or create a new one</div></div>';
    lucide.createIcons();
  }
  await refreshPages();
}

// ‚îÄ‚îÄ Keyboard Shortcuts ‚îÄ‚îÄ
function setupKeys(){
  document.addEventListener('keydown', e => {
    if((e.metaKey||e.ctrlKey) && e.key==='k'){e.preventDefault();openSearch();}
    if(e.key==='Escape'){closeSearch();hideSlashMenu();}
  });
  document.addEventListener('click', e => {
    if(!e.target.closest('#slash-menu') && !e.target.closest('[data-block-id]')) hideSlashMenu();
  });
  // Prevent slash menu scroll/click from stealing focus
  document.getElementById('slash-menu').addEventListener('mousedown', e => {
    if(!e.target.closest('.slash-item')) e.preventDefault();
  });
}

// ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// ‚îÄ‚îÄ Dialog ‚îÄ‚îÄ
function showDialog(title, msg, okLabel='Delete', okClass='btn-danger'){
  return new Promise(resolve => {
    dialogCb = resolve;
    document.getElementById('dialog-title').textContent = title;
    document.getElementById('dialog-msg').textContent = msg;
    const btn = document.getElementById('dialog-ok');
    btn.textContent = okLabel;
    btn.className = 'btn ' + okClass;
    document.getElementById('dialog').classList.add('open');
  });
}
function closeDialog(val){
  document.getElementById('dialog').classList.remove('open');
  if(dialogCb){dialogCb(val);dialogCb=null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKSPACE & DATABASE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentWorkspace = 'docs';
let databases = [];
let currentDb = null;
let currentDbView = null;
let currentDbItems = [];

function switchWorkspace(ws){
  currentWorkspace = ws;
  document.querySelectorAll('.ws-tab').forEach(t => t.classList.toggle('active', t.dataset.ws === ws));
  document.querySelectorAll('.ws-content').forEach(c => c.classList.toggle('active', c.id === 'ws-'+ws));
  if(ws === 'docs'){
    refreshPages();
  } else {
    loadDatabases(ws);
  }
}

async function loadDatabases(workspace){
  databases = await api('/databases?workspace='+workspace);
  const listId = workspace === 'projects' ? 'project-list' : 'wiki-list';
  const el = document.getElementById(listId);
  if(!databases.length){
    el.innerHTML = `<div style="padding:8px;font-size:12px;color:var(--text4)">No ${workspace === 'projects' ? 'projects' : 'knowledge bases'} yet</div>`;
  } else {
    el.innerHTML = databases.map(db => `
      <div class="page-item${currentDb && currentDb.id === db.id ? ' active' : ''}" onclick="loadDatabase('${db.id}')" oncontextmenu="dbMenu(event,'${db.id}')">
        <span class="p-icon">${renderIcon(db.icon || (workspace==='projects'?'layout-grid':'book-open'), 16)}</span>
        <span class="p-title">${esc(db.title)}</span>
      </div>
    `).join('');
  }
  lucide.createIcons();
}

async function createDatabase(workspace){
  const title = workspace === 'projects' ? 'New Project' : 'New Knowledge Base';
  const icon = workspace === 'projects' ? 'layout-grid' : 'book-open';
  const db = await api('/databases', {method:'POST', body:{title, icon, workspace}});
  await loadDatabases(workspace);
  await loadDatabase(db.id);
}

async function loadDatabase(dbId){
  const data = await api('/databases/'+dbId);
  currentDb = data;
  currentDbItems = data.items || [];
  currentDbView = data.views?.[0] || null;
  currentPage = null;
  renderDatabase();
  loadDatabases(currentDb.workspace);
}

function renderDatabase(){
  if(!currentDb) return;
  const area = document.getElementById('page-area');
  const welcome = document.getElementById('welcome');
  if(welcome) welcome.style.display = 'none';
  document.getElementById('breadcrumbs').innerHTML = `<span class="current">${renderIcon(currentDb.icon,16)} ${esc(currentDb.title)}</span>`;
  
  const schema = currentDb.properties_schema || [];
  const views = currentDb.views || [];
  
  let html = '';
  
  // Header
  html += `<div style="width:100%">`;
  html += `<div class="db-header">
    <div class="db-title" contenteditable="true" placeholder="Untitled" oninput="onDbTitleChange(this)">${esc(currentDb.title)}</div>
    <div class="db-desc" contenteditable="true" oninput="onDbDescChange(this)">${esc(currentDb.description)}</div>
  </div>`;
  
  // View tabs
  html += `<div class="view-tabs">`;
  views.forEach(v => {
    const icon = v.type==='board'?'kanban':v.type==='table'?'table':'list';
    html += `<button class="view-tab${currentDbView && currentDbView.id===v.id?' active':''}" onclick="switchView('${v.id}')">
      <i data-lucide="${icon}" style="width:14px;height:14px"></i> ${esc(v.name)}</button>`;
  });
  html += `<span class="view-add" onclick="addView()"><i data-lucide="plus" style="width:14px;height:14px"></i></span>`;
  html += `</div>`;
  
  // View content
  if(currentDbView){
    if(currentDbView.type === 'table') html += renderTableView(schema);
    else if(currentDbView.type === 'board') html += renderBoardView(schema);
    else if(currentDbView.type === 'list') html += renderListView(schema);
  }
  
  html += `</div>`;
  area.innerHTML = html;
  lucide.createIcons();
}

function renderTableView(schema){
  let html = `<div class="db-table-wrap"><table class="db-table"><thead><tr>`;
  html += `<th style="min-width:200px">Title</th>`;
  schema.forEach(p => { html += `<th>${esc(p.name)}</th>`; });
  html += `</tr></thead><tbody>`;
  
  currentDbItems.forEach(item => {
    html += `<tr onclick="openItemEditor('${item.id}')">`;
    html += `<td><div class="title-cell">${renderIcon(item.icon,14)} ${esc(item.title)}</div></td>`;
    schema.forEach(prop => {
      const val = (item.properties || {})[prop.id];
      html += `<td>${renderPropValue(prop, val)}</td>`;
    });
    html += `</tr>`;
  });
  
  // New row
  html += `<tr class="new-row" onclick="addDbItem()"><td colspan="${schema.length+1}"><i data-lucide="plus" style="width:12px;height:12px;vertical-align:middle"></i> New</td></tr>`;
  html += `</tbody></table></div>`;
  return html;
}

function renderBoardView(schema){
  const config = currentDbView?.config || {};
  const groupBy = config.group_by;
  const groupProp = schema.find(p => p.id === groupBy);
  
  if(!groupProp || groupProp.type !== 'select'){
    return `<div style="padding:40px;text-align:center;color:var(--text3)">Board view needs a Select property to group by</div>`;
  }
  
  const groups = {};
  (groupProp.options || []).forEach(opt => { groups[opt.name] = {color: opt.color, items: []}; });
  groups['No Status'] = {color: '#374151', items: []};
  
  currentDbItems.forEach(item => {
    const val = (item.properties || {})[groupBy];
    if(val && groups[val]) groups[val].items.push(item);
    else groups['No Status'].items.push(item);
  });
  
  let html = `<div class="db-board">`;
  Object.entries(groups).forEach(([name, group]) => {
    html += `<div class="board-col" data-group="${esc(name)}">
      <div class="board-col-header">
        <span class="col-tag" style="background:${group.color};color:#fff">${esc(name)}</span>
        <span class="col-count">${group.items.length}</span>
      </div>
      <div class="board-cards" data-group="${esc(name)}"
        ondragover="event.preventDefault();this.classList.add('drag-over')"
        ondragleave="this.classList.remove('drag-over')"
        ondrop="boardDrop(event,'${esc(name)}','${groupBy}')">`;
    group.items.forEach(item => {
      html += `<div class="board-card" draggable="true" data-item-id="${item.id}"
        ondragstart="event.dataTransfer.setData('text/plain','${item.id}')"
        onclick="openItemEditor('${item.id}')">
        <div class="card-title">${esc(item.title)}</div>
        <div class="card-props">`;
      schema.forEach(p => {
        if(p.id === groupBy) return;
        const val = (item.properties || {})[p.id];
        if(val) html += renderPropValue(p, val);
      });
      html += `</div></div>`;
    });
    html += `<div class="board-add" onclick="addDbItem({${groupBy}:'${esc(name)}'})">
      <i data-lucide="plus" style="width:12px;height:12px"></i> New
    </div></div></div>`;
  });
  html += `</div>`;
  return html;
}

function renderListView(schema){
  let html = `<div class="db-list">`;
  currentDbItems.forEach(item => {
    html += `<div class="list-item" onclick="openItemEditor('${item.id}')">
      <span>${renderIcon(item.icon,16)}</span>
      <span class="li-title">${esc(item.title)}</span>
      <div class="li-props">`;
    schema.forEach(p => {
      const val = (item.properties || {})[p.id];
      if(val) html += renderPropValue(p, val);
    });
    html += `</div></div>`;
  });
  html += `<div class="list-item" onclick="addDbItem()" style="color:var(--text4)">
    <i data-lucide="plus" style="width:14px;height:14px"></i>
    <span class="li-title">New item</span>
  </div>`;
  html += `</div>`;
  return html;
}

function renderPropValue(prop, val){
  if(!val && val !== 0 && val !== false) return '';
  if(prop.type === 'select'){
    const opt = (prop.options||[]).find(o => o.name === val);
    const color = opt?.color || '#6B7280';
    return `<span class="prop-tag" style="background:${color}22;color:${color}">${esc(val)}</span>`;
  }
  if(prop.type === 'multi_select'){
    const vals = Array.isArray(val) ? val : [val];
    return `<span class="prop-multi">${vals.map(v => {
      const opt = (prop.options||[]).find(o => o.name === v);
      const color = opt?.color || '#6B7280';
      return `<span class="prop-tag" style="background:${color}22;color:${color}">${esc(v)}</span>`;
    }).join('')}</span>`;
  }
  if(prop.type === 'date') return `<span class="prop-date">${esc(val)}</span>`;
  if(prop.type === 'checkbox') return `<input type="checkbox" class="prop-checkbox" ${val?'checked':''} disabled>`;
  if(prop.type === 'number') return `<span class="prop-number">${val}</span>`;
  return `<span class="prop-text">${esc(String(val))}</span>`;
}

// Board drag & drop
async function boardDrop(e, groupName, propId){
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const itemId = e.dataTransfer.getData('text/plain');
  if(!itemId) return;
  const item = currentDbItems.find(i => i.id === itemId);
  if(!item) return;
  item.properties = item.properties || {};
  item.properties[propId] = groupName === 'No Status' ? '' : groupName;
  await api('/databases/'+currentDb.id+'/items/'+itemId, {method:'PUT', body:{properties:{[propId]: item.properties[propId]}}});
  renderDatabase();
}

// Add DB item
async function addDbItem(defaultProps){
  const props = defaultProps || {};
  const item = await api('/databases/'+currentDb.id+'/items', {method:'POST', body:{title:'Untitled', properties:props}});
  currentDbItems.push(item);
  renderDatabase();
  // Auto-open editor
  setTimeout(() => openItemEditor(item.id), 100);
}

// Item editor
function openItemEditor(itemId){
  const item = currentDbItems.find(i => i.id === itemId);
  if(!item) return;
  const schema = currentDb.properties_schema || [];
  const panel = document.getElementById('prop-editor');
  document.getElementById('pe-title').textContent = item.title;
  
  let html = `<div class="pe-field">
    <label>Title</label>
    <input type="text" value="${esc(item.title)}" oninput="updateItemTitle('${item.id}',this.value)">
  </div>`;
  
  schema.forEach(prop => {
    const val = (item.properties || {})[prop.id];
    html += `<div class="pe-field"><label>${esc(prop.name)}</label>`;
    
    if(prop.type === 'text'){
      html += `<input type="text" value="${esc(val||'')}" oninput="updateItemProp('${item.id}','${prop.id}',this.value)">`;
    }
    else if(prop.type === 'number'){
      html += `<input type="number" value="${val||''}" oninput="updateItemProp('${item.id}','${prop.id}',this.valueAsNumber)">`;
    }
    else if(prop.type === 'date'){
      html += `<input type="date" value="${val||''}" oninput="updateItemProp('${item.id}','${prop.id}',this.value)">`;
    }
    else if(prop.type === 'checkbox'){
      html += `<input type="checkbox" ${val?'checked':''} onchange="updateItemProp('${item.id}','${prop.id}',this.checked)" style="width:auto">`;
    }
    else if(prop.type === 'select'){
      html += `<div class="pe-select-opts">`;
      (prop.options||[]).forEach(opt => {
        const sel = val === opt.name ? ' selected' : '';
        html += `<span class="pe-select-opt${sel}" style="background:${opt.color}22;color:${opt.color}" 
          onclick="updateItemProp('${item.id}','${prop.id}','${esc(opt.name)}');renderPeSelect(this)">${esc(opt.name)}</span>`;
      });
      html += `</div>`;
    }
    else if(prop.type === 'multi_select'){
      const vals = Array.isArray(val) ? val : (val ? [val] : []);
      html += `<div class="pe-select-opts">`;
      (prop.options||[]).forEach(opt => {
        const sel = vals.includes(opt.name) ? ' selected' : '';
        html += `<span class="pe-select-opt${sel}" style="background:${opt.color}22;color:${opt.color}"
          onclick="toggleMultiSelect('${item.id}','${prop.id}','${esc(opt.name)}',this)">${esc(opt.name)}</span>`;
      });
      html += `</div>`;
    }
    html += `</div>`;
  });
  
  // Open page link
  if(item.page_id){
    html += `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
      <button class="btn btn-ghost" onclick="closePropEditor();switchWorkspace('docs');loadPage('${item.page_id}')">
        <i data-lucide="file-text" style="width:14px;height:14px;margin-right:4px"></i> Open full page
      </button>
    </div>`;
  }
  
  // Delete
  html += `<div style="margin-top:16px">
    <button class="btn btn-danger" onclick="deleteDbItem('${item.id}')">Delete item</button>
  </div>`;
  
  document.getElementById('pe-body').innerHTML = html;
  panel.classList.add('open');
  lucide.createIcons();
}

function closePropEditor(){
  document.getElementById('prop-editor').classList.remove('open');
}

function renderPeSelect(el){
  el.closest('.pe-select-opts').querySelectorAll('.pe-select-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
}

let propTimers = {};
async function updateItemProp(itemId, propId, value){
  const item = currentDbItems.find(i => i.id === itemId);
  if(!item) return;
  item.properties = item.properties || {};
  item.properties[propId] = value;
  clearTimeout(propTimers[itemId+propId]);
  propTimers[itemId+propId] = setTimeout(async () => {
    await api('/databases/'+currentDb.id+'/items/'+itemId, {method:'PUT', body:{properties:{[propId]:value}}});
    renderDatabase();
  }, 300);
}

async function updateItemTitle(itemId, title){
  const item = currentDbItems.find(i => i.id === itemId);
  if(!item) return;
  item.title = title;
  document.getElementById('pe-title').textContent = title;
  clearTimeout(propTimers['title'+itemId]);
  propTimers['title'+itemId] = setTimeout(async () => {
    await api('/databases/'+currentDb.id+'/items/'+itemId, {method:'PUT', body:{title}});
    renderDatabase();
  }, 300);
}

function toggleMultiSelect(itemId, propId, optName, el){
  const item = currentDbItems.find(i => i.id === itemId);
  if(!item) return;
  item.properties = item.properties || {};
  let vals = Array.isArray(item.properties[propId]) ? [...item.properties[propId]] : [];
  const idx = vals.indexOf(optName);
  if(idx >= 0) vals.splice(idx, 1); else vals.push(optName);
  item.properties[propId] = vals;
  el.classList.toggle('selected');
  clearTimeout(propTimers[itemId+propId]);
  propTimers[itemId+propId] = setTimeout(async () => {
    await api('/databases/'+currentDb.id+'/items/'+itemId, {method:'PUT', body:{properties:{[propId]:vals}}});
    renderDatabase();
  }, 300);
}

async function deleteDbItem(itemId){
  if(!confirm('Delete this item?')) return;
  await api('/databases/'+currentDb.id+'/items/'+itemId, {method:'DELETE'});
  currentDbItems = currentDbItems.filter(i => i.id !== itemId);
  closePropEditor();
  renderDatabase();
}

async function switchView(viewId){
  currentDbView = currentDb.views.find(v => v.id === viewId);
  renderDatabase();
}

async function addView(){
  const types = ['table','board','list'];
  const current = currentDbView?.type || 'table';
  const next = types[(types.indexOf(current)+1) % types.length];
  const name = next === 'table' ? 'Table' : next === 'board' ? 'Board' : 'List';
  const schema = currentDb.properties_schema || [];
  const groupBy = schema.find(p => p.type === 'select')?.id;
  const config = next === 'board' && groupBy ? {group_by: groupBy} : {};
  const view = await api('/databases/'+currentDb.id+'/views', {method:'POST', body:{name, type:next, config}});
  currentDb.views.push(view);
  currentDbView = view;
  renderDatabase();
}

let dbTitleTimer;
function onDbTitleChange(el){
  clearTimeout(dbTitleTimer);
  dbTitleTimer = setTimeout(async () => {
    currentDb.title = el.innerText.trim() || 'Untitled';
    await api('/databases/'+currentDb.id, {method:'PUT', body:{title:currentDb.title}});
    loadDatabases(currentDb.workspace);
  }, 500);
}

let dbDescTimer;
function onDbDescChange(el){
  clearTimeout(dbDescTimer);
  dbDescTimer = setTimeout(async () => {
    currentDb.description = el.innerText.trim();
    await api('/databases/'+currentDb.id, {method:'PUT', body:{description:currentDb.description}});
  }, 500);
}

function dbMenu(e, dbId){
  e.preventDefault();
  e.stopPropagation();
  const db = databases.find(d => d.id === dbId);
  if(!db) return;
  const menu = document.createElement('div');
  menu.style.cssText = `position:fixed;left:${e.clientX}px;top:${e.clientY}px;z-index:200;background:var(--bg3);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5);padding:4px;min-width:160px;animation:menuIn 100ms ease-out`;
  [{label:'Delete', danger:true, action: async () => {
    if(!confirm('Delete this database and all items?')) return;
    await api('/databases/'+dbId, {method:'DELETE'});
    if(currentDb && currentDb.id === dbId) { currentDb = null; document.getElementById('page-area').innerHTML = '<div class="welcome" id="welcome"><i data-lucide="brain"></i><p>Brain Notes</p></div>'; lucide.createIcons(); }
    loadDatabases(db.workspace);
  }}].forEach(item => {
    const el = document.createElement('div');
    el.style.cssText = `padding:6px 12px;border-radius:4px;cursor:pointer;font-size:13px;color:${item.danger?'var(--red)':'var(--text2)'};transition:background 80ms`;
    el.textContent = item.label;
    el.onmouseover = () => el.style.background = 'var(--card-hover)';
    el.onmouseout = () => el.style.background = 'none';
    el.onclick = () => { document.body.removeChild(menu); item.action(); };
    menu.appendChild(el);
  });
  document.body.appendChild(menu);
  setTimeout(() => document.addEventListener('click', function rm(){ document.body.contains(menu) && document.body.removeChild(menu); document.removeEventListener('click',rm); }), 10);
}

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function esc(s){if(!s)return '';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
</script>
</body>
</html>
