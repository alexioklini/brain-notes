<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brain Notes</title>
<script src="https://cdn.jsdelivr.net/npm/lucide@0.309.0/dist/umd/lucide.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê Design System (Health App) ‚ïê‚ïê‚ïê */
:root {
  --bg: #0d0d0d; --bg2: #111111; --bg3: #161616;
  --card: rgba(255,255,255,0.03); --card-hover: rgba(255,255,255,0.06);
  --border: rgba(255,255,255,0.06); --border-hover: rgba(255,255,255,0.12);
  --text: #f0f0f0; --text2: rgba(255,255,255,0.65); --text3: rgba(255,255,255,0.45); --text4: rgba(255,255,255,0.25);
  --cyan: #00D4FF; --green: #00E676; --purple: #B388FF; --orange: #FF9100;
  --pink: #FF4081; --yellow: #FFD600; --blue: #4a90d9; --red: #FF5252;
  --radius: 8px; --transition: 150ms ease;
  --sidebar-w: 260px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:15px;line-height:1.6}
::selection{background:rgba(0,212,255,.2)}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.15)}
a{color:var(--cyan);text-decoration:none}

/* ‚ïê‚ïê‚ïê Layout ‚ïê‚ïê‚ïê */
#app{display:flex;height:100vh}

/* ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê */
#sidebar{width:var(--sidebar-w);background:var(--bg2);display:flex;flex-direction:column;border-right:1px solid var(--border);flex-shrink:0;transition:width 200ms}
#sidebar.collapsed{width:0;overflow:hidden;border:none}
.sb-header{padding:16px 14px 8px;display:flex;align-items:center;gap:8px}
.sb-header h1{font-size:13px;font-weight:600;color:var(--text);flex:1;display:flex;align-items:center;gap:6px}
.sb-header h1 svg{color:var(--cyan)}
.sb-btn{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all var(--transition)}
.sb-btn:hover{background:var(--card-hover);color:var(--text)}

.sb-section{padding:4px 8px}
.sb-section-title{font-size:11px;font-weight:500;color:var(--text4);text-transform:uppercase;letter-spacing:.5px;padding:8px 6px 4px}

.sb-search{margin:4px 8px 8px;position:relative}
.sb-search input{width:100%;padding:6px 10px 6px 30px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;outline:none;transition:border-color var(--transition)}
.sb-search input:focus{border-color:var(--cyan)}
.sb-search svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text4);width:13px;height:13px;pointer-events:none}

.page-list{flex:1;overflow-y:auto;padding:0 4px 8px}
.page-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:6px;cursor:pointer;color:var(--text2);font-size:13px;transition:all var(--transition);user-select:none;position:relative}
.page-item:hover{background:var(--card-hover);color:var(--text)}
.page-item.active{background:rgba(0,212,255,.08);color:var(--text)}
.page-item .p-icon{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.page-item .p-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.page-item .p-toggle{opacity:0;transition:opacity var(--transition);color:var(--text4)}
.page-item:hover .p-toggle{opacity:1}
.page-item .p-add{opacity:0;transition:opacity var(--transition);color:var(--text4)}
.page-item:hover .p-add{opacity:1}
.page-children{padding-left:16px}
.page-children.collapsed{display:none}

.sb-new-page{display:flex;align-items:center;gap:6px;padding:6px 12px;margin:4px 8px;border-radius:6px;cursor:pointer;color:var(--text3);font-size:13px;transition:all var(--transition);border:none;background:none;width:calc(100% - 16px)}
.sb-new-page:hover{background:var(--card-hover);color:var(--text)}

/* ‚ïê‚ïê‚ïê Main ‚ïê‚ïê‚ïê */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

/* Topbar */
.topbar{height:42px;display:flex;align-items:center;padding:0 16px;gap:8px;border-bottom:1px solid var(--border);flex-shrink:0}
.topbar .breadcrumbs{display:flex;align-items:center;gap:4px;font-size:13px;color:var(--text3);flex:1;min-width:0}
.topbar .breadcrumbs span{white-space:nowrap;cursor:pointer}
.topbar .breadcrumbs span:hover{color:var(--text)}
.topbar .breadcrumbs .sep{color:var(--text4)}
.topbar .breadcrumbs .current{color:var(--text);font-weight:500}
.tb-btn{background:none;border:none;color:var(--text3);cursor:pointer;padding:5px;border-radius:4px;display:flex;align-items:center;transition:all var(--transition)}
.tb-btn:hover{background:var(--card-hover);color:var(--text)}

/* ‚ïê‚ïê‚ïê Page Content ‚ïê‚ïê‚ïê */
#page-area{flex:1;overflow-y:auto;display:flex;justify-content:center}
.page-content{max-width:720px;width:100%;padding:40px 24px 100px;position:relative}

/* Cover */
.page-cover{height:200px;border-radius:0 0 var(--radius) var(--radius);background-size:cover;background-position:center;margin:-40px -24px 20px;position:relative}
.page-cover:hover .cover-actions{opacity:1}
.cover-actions{position:absolute;bottom:10px;right:10px;opacity:0;transition:opacity var(--transition);display:flex;gap:4px}

/* Page header */
.page-header{margin-bottom:24px}
.page-icon{font-size:48px;cursor:pointer;display:inline-block;padding:4px;border-radius:6px;transition:background var(--transition);line-height:1.2}
.page-icon:hover{background:var(--card-hover)}
.page-title{font-size:36px;font-weight:700;color:var(--text);border:none;background:none;outline:none;width:100%;line-height:1.2;margin:8px 0 4px;font-family:inherit;display:block}
.page-title:empty::before{content:attr(placeholder);color:var(--text4)}
.page-title::placeholder{color:var(--text4)}
.page-meta{font-size:12px;color:var(--text4);margin-bottom:4px}
.page-header-actions{display:flex;gap:8px;margin-top:4px;opacity:0;transition:opacity var(--transition)}
.page-header:hover .page-header-actions{opacity:1}
.meta-btn{background:none;border:none;color:var(--text4);cursor:pointer;font-size:12px;padding:2px 6px;border-radius:4px;display:flex;align-items:center;gap:4px;font-family:inherit;transition:all var(--transition)}
.meta-btn:hover{background:var(--card-hover);color:var(--text3)}

/* ‚ïê‚ïê‚ïê Block Editor ‚ïê‚ïê‚ïê */
.block{display:flex;align-items:flex-start;gap:0;position:relative;border-radius:4px;transition:background 80ms}
.block:hover{background:var(--card)}
.block:hover .block-handle{opacity:1}
.block-handle{opacity:0;display:flex;align-items:center;gap:0;padding:3px 2px;cursor:grab;color:var(--text4);flex-shrink:0;transition:opacity var(--transition);margin-top:2px}
.block-handle:hover{color:var(--text3)}
.block-handle svg{width:14px;height:14px}
.block-add{cursor:pointer;border-radius:4px;padding:1px;transition:all var(--transition)}
.block-add:hover{background:var(--card-hover);color:var(--text)}
.block-drag{cursor:grab;border-radius:4px;padding:1px;transition:all var(--transition)}
.block-drag:hover{background:var(--card-hover)}
.block-content{flex:1;outline:none;min-height:1.6em;padding:3px 4px;word-break:break-word;min-width:0}
.block-content:empty::before{content:attr(data-placeholder);color:var(--text4)}
.block-content[contenteditable="true"]:focus{outline:none}

/* Block types */
.block[data-type="h1"] .block-content{font-size:30px;font-weight:700;line-height:1.2;padding-top:16px;padding-bottom:4px}
.block[data-type="h2"] .block-content{font-size:24px;font-weight:600;line-height:1.25;padding-top:12px;padding-bottom:2px;color:var(--text)}
.block[data-type="h3"] .block-content{font-size:20px;font-weight:600;line-height:1.3;padding-top:8px;color:var(--text)}
.block[data-type="quote"] .block-content{border-left:3px solid var(--text4);padding-left:14px;color:var(--text2);font-style:italic}
.block[data-type="callout"]{background:rgba(0,212,255,.06)!important;border-radius:6px;padding:12px 8px;margin:4px 0}
.block[data-type="callout"] .block-content{padding-left:8px}
.block[data-type="callout"] .callout-icon{font-size:20px;padding:0 4px;cursor:pointer}
.block[data-type="code"]{background:var(--bg2)!important;border:1px solid var(--border);border-radius:6px;margin:4px 0}
.block[data-type="code"] .block-content{font-family:'JetBrains Mono',monospace;font-size:13px;padding:12px;white-space:pre-wrap;color:var(--green)}
.block[data-type="divider"]{padding:8px 0}
.block[data-type="divider"] .block-content{height:1px;background:var(--border);min-height:1px;padding:0;cursor:default}
.block[data-type="todo"] .block-content{display:flex;align-items:flex-start;gap:8px}
.block[data-type="todo"] input[type="checkbox"]{margin-top:4px;accent-color:var(--cyan);width:16px;height:16px;cursor:pointer;flex-shrink:0}
.block[data-type="todo"] .todo-text{flex:1;outline:none;min-height:1.6em}
.block[data-type="todo"].checked .todo-text{text-decoration:line-through;color:var(--text4)}
.block[data-type="bullet"] .block-content::before{content:'‚Ä¢';color:var(--text3);margin-right:8px;font-weight:bold}
.block[data-type="numbered"] .block-content::before{content:attr(data-number) '.';color:var(--text3);margin-right:8px;min-width:18px;display:inline-block}
.block[data-type="toggle"] .toggle-arrow{cursor:pointer;transition:transform var(--transition);color:var(--text4);flex-shrink:0;padding:4px 2px}
.block[data-type="toggle"] .toggle-arrow.open{transform:rotate(90deg)}
.block[data-type="toggle"] .toggle-children{padding-left:24px}
.block[data-type="toggle"] .toggle-children.hidden{display:none}
.block[data-type="page_link"]{cursor:pointer}
.block[data-type="page_link"] .block-content{color:var(--cyan);display:flex;align-items:center;gap:6px}
.block[data-type="page_link"]:hover .block-content{text-decoration:underline}

/* Block indent */
.block[data-indent="1"]{margin-left:24px}
.block[data-indent="2"]{margin-left:48px}
.block[data-indent="3"]{margin-left:72px}

/* Drag indicator */
.block.drag-over-top{border-top:2px solid var(--cyan);margin-top:-2px}
.block.drag-over-bottom{border-bottom:2px solid var(--cyan);margin-bottom:-2px}
.block.dragging{opacity:.3}

/* ‚ïê‚ïê‚ïê Slash Menu ‚ïê‚ïê‚ïê */
#slash-menu{position:absolute;z-index:100;background:var(--bg3);border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 40px rgba(0,0,0,.5);width:280px;max-height:320px;overflow-y:auto;display:none;animation:menuIn 100ms ease-out}
@keyframes menuIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
#slash-menu.open{display:block}
.slash-section{padding:6px 0}
.slash-section-title{font-size:11px;font-weight:500;color:var(--text4);padding:4px 12px;text-transform:uppercase;letter-spacing:.5px}
.slash-item{display:flex;align-items:center;gap:10px;padding:6px 12px;cursor:pointer;transition:background 80ms;border-radius:4px;margin:0 4px}
.slash-item:hover,.slash-item.focused{background:var(--card-hover)}
.slash-item .si-icon{width:36px;height:36px;border-radius:6px;background:var(--card);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--text2);flex-shrink:0}
.slash-item .si-info{flex:1;min-width:0}
.slash-item .si-name{font-size:13px;color:var(--text);font-weight:500}
.slash-item .si-desc{font-size:11px;color:var(--text4)}

/* ‚ïê‚ïê‚ïê Search Modal ‚ïê‚ïê‚ïê */
#search-modal{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);justify-content:center;padding-top:15vh}
#search-modal.open{display:flex}
.search-box{width:520px;max-height:55vh;background:var(--bg3);border:1px solid var(--border);border-radius:12px;box-shadow:0 24px 80px rgba(0,0,0,.6);overflow:hidden;display:flex;flex-direction:column;animation:menuIn 150ms ease-out}
.search-box input{width:100%;padding:14px 18px;border:none;background:none;color:var(--text);font-size:15px;outline:none;border-bottom:1px solid var(--border);font-family:inherit}
.search-box input::placeholder{color:var(--text4)}
.search-results{overflow-y:auto;flex:1;padding:4px}
.search-item{display:flex;align-items:center;gap:10px;padding:8px 14px;cursor:pointer;border-radius:6px;margin:2px;transition:background 80ms}
.search-item:hover,.search-item.focused{background:var(--card-hover)}
.search-item .si-icon{font-size:16px;width:20px;text-align:center}
.search-item .si-title{font-size:14px;color:var(--text)}
.search-item .si-snippet{font-size:12px;color:var(--text4);margin-top:1px}
.search-empty{padding:24px;text-align:center;color:var(--text4);font-size:13px}

/* ‚ïê‚ïê‚ïê Icon Picker ‚ïê‚ïê‚ïê */
#icon-picker{display:none;position:absolute;z-index:150;background:var(--bg3);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.5);padding:12px;width:320px;animation:menuIn 100ms ease-out}
#icon-picker.open{display:block}
.icon-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-height:240px;overflow-y:auto}
.icon-option{width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border-radius:6px;transition:background var(--transition)}
.icon-option:hover{background:var(--card-hover)}

/* ‚ïê‚ïê‚ïê Custom Dialog ‚ïê‚ïê‚ïê */
#dialog{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);justify-content:center;padding-top:25vh}
#dialog.open{display:flex}
.dialog-box{width:380px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;box-shadow:0 24px 80px rgba(0,0,0,.6);padding:24px;animation:menuIn 150ms ease-out}
.dialog-box h3{font-size:15px;font-weight:600;margin-bottom:8px}
.dialog-box p{font-size:13px;color:var(--text3);margin-bottom:16px}
.dialog-btns{display:flex;gap:8px;justify-content:flex-end}
.btn{padding:7px 14px;border-radius:6px;border:none;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;transition:all var(--transition)}
.btn-primary{background:var(--cyan);color:#0d0d0d}
.btn-primary:hover{opacity:.9}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{opacity:.9}
.btn-ghost{background:none;color:var(--text3)}
.btn-ghost:hover{background:var(--card-hover);color:var(--text)}

/* ‚ïê‚ïê‚ïê Empty / Welcome ‚ïê‚ïê‚ïê */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text4);gap:12px}
.welcome svg{width:48px;height:48px;opacity:.2}
.welcome p{font-size:14px}
.welcome .hint{font-size:12px;color:var(--text4)}

/* ‚ïê‚ïê‚ïê Inline Format Toolbar ‚ïê‚ïê‚ïê */
#format-bar{display:none;position:absolute;z-index:100;background:var(--bg3);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.4);padding:2px;flex-wrap:nowrap;gap:0}
#format-bar.open{display:flex}
.fmt-btn{padding:5px 8px;border:none;background:none;color:var(--text2);cursor:pointer;border-radius:4px;font-size:13px;font-family:inherit;font-weight:500;transition:all 80ms;display:flex;align-items:center}
.fmt-btn:hover{background:var(--card-hover);color:var(--text)}
.fmt-btn.active{color:var(--cyan)}
.fmt-sep{width:1px;background:var(--border);margin:4px 2px}

@media(max-width:768px){
  :root{--sidebar-w:100vw}
  #sidebar{position:fixed;top:0;left:0;bottom:0;z-index:50;transform:translateX(-100%);transition:transform 200ms}
  #sidebar:not(.collapsed){transform:translateX(0)}
}
</style>
</head>
<body>
<div id="app">
  <!-- ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê -->
  <aside id="sidebar">
    <div class="sb-header">
      <h1><i data-lucide="brain"></i> Brain Notes</h1>
      <button class="sb-btn" onclick="toggleSidebar()" title="Collapse"><i data-lucide="panel-left"></i></button>
    </div>
    <div class="sb-search">
      <i data-lucide="search"></i>
      <input type="text" placeholder="Search..." onkeydown="if(event.key==='Enter')openSearch(this.value)" onfocus="openSearch()">
    </div>
    <div class="sb-section">
      <button class="sb-new-page" onclick="createPage()"><i data-lucide="plus" style="width:14px;height:14px"></i> New page</button>
    </div>
    <div class="sb-section">
      <div class="sb-section-title">Favorites</div>
      <div id="favorites-list"></div>
    </div>
    <div class="sb-section" style="flex:1;overflow-y:auto">
      <div class="sb-section-title">Pages</div>
      <div id="page-list" class="page-list"></div>
    </div>
  </aside>

  <!-- ‚ïê‚ïê‚ïê Main ‚ïê‚ïê‚ïê -->
  <div id="main">
    <div class="topbar">
      <button class="tb-btn" onclick="toggleSidebar()"><i data-lucide="panel-left"></i></button>
      <div class="breadcrumbs" id="breadcrumbs"></div>
      <button class="tb-btn" onclick="openSearch()" title="Search (‚åòK)"><i data-lucide="search"></i></button>
    </div>
    <div id="page-area">
      <div class="welcome" id="welcome">
        <i data-lucide="brain"></i>
        <p>Brain Notes</p>
        <div class="hint">Select a page or create a new one</div>
      </div>
    </div>
  </div>
</div>

<!-- Slash Menu -->
<div id="slash-menu"></div>

<!-- Search Modal -->
<div id="search-modal" onclick="if(event.target===this)closeSearch()">
  <div class="search-box">
    <input type="text" id="search-input" placeholder="Search pages and blocks..." oninput="doSearch(this.value)" onkeydown="searchKeys(event)">
    <div class="search-results" id="search-results"><div class="search-empty">Type to search</div></div>
  </div>
</div>

<!-- Icon Picker -->
<div id="icon-picker"></div>

<!-- Format Bar -->
<div id="format-bar">
  <button class="fmt-btn" onmousedown="execFmt(event,'bold')"><b>B</b></button>
  <button class="fmt-btn" onmousedown="execFmt(event,'italic')"><i>i</i></button>
  <button class="fmt-btn" onmousedown="execFmt(event,'underline')"><u>U</u></button>
  <button class="fmt-btn" onmousedown="execFmt(event,'strikeThrough')"><s>S</s></button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" onmousedown="execFmt(event,'code')"><code style="font-size:12px;font-family:'JetBrains Mono',monospace">&lt;/&gt;</code></button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" onmousedown="execFmt(event,'link')">üîó</button>
</div>

<!-- Dialog -->
<div id="dialog" onclick="if(event.target===this)closeDialog(null)">
  <div class="dialog-box">
    <h3 id="dialog-title"></h3>
    <p id="dialog-msg"></p>
    <div class="dialog-btns">
      <button class="btn btn-ghost" onclick="closeDialog(null)">Cancel</button>
      <button class="btn btn-danger" id="dialog-ok" onclick="closeDialog(true)">Delete</button>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BRAIN NOTES ‚Äî Notion Clone
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let pages = [];
let currentPage = null;
let currentBlocks = [];
let slashBlock = null;
let slashIdx = -1;
let searchIdx = -1;
let dialogCb = null;

const api = (path, opts={}) => fetch('/api'+path, {
  headers:{'Content-Type':'application/json'}, ...opts,
  body: opts.body ? JSON.stringify(opts.body) : undefined
}).then(r=>r.json());

const ICONS = ['üìù','üìÅ','üéØ','üí°','üî•','‚≠ê','üöÄ','üìä','üé®','üìå','üíª','üîß','üìö','üéµ','üåç','üè†','‚ù§Ô∏è','‚ö°','üß™','üìê','üóÇÔ∏è','üìã','‚úÖ','üîç','üí∞','üéì','üîí','üìà','üéÆ','üå±'];

const BLOCK_TYPES = [
  {section:'Basic', items:[
    {type:'text',icon:'T',name:'Text',desc:'Plain text block'},
    {type:'h1',icon:'H‚ÇÅ',name:'Heading 1',desc:'Large heading'},
    {type:'h2',icon:'H‚ÇÇ',name:'Heading 2',desc:'Medium heading'},
    {type:'h3',icon:'H‚ÇÉ',name:'Heading 3',desc:'Small heading'},
    {type:'bullet',icon:'‚Ä¢',name:'Bullet List',desc:'Simple bullet list'},
    {type:'numbered',icon:'1.',name:'Numbered List',desc:'Numbered list'},
    {type:'todo',icon:'‚òë',name:'To-do',desc:'Track tasks with checkboxes'},
    {type:'toggle',icon:'‚ñ∂',name:'Toggle',desc:'Collapsible content'},
  ]},
  {section:'Media & Advanced', items:[
    {type:'quote',icon:'‚ùù',name:'Quote',desc:'Capture a quote'},
    {type:'callout',icon:'üí°',name:'Callout',desc:'Highlighted info block'},
    {type:'code',icon:'</>',name:'Code',desc:'Code snippet'},
    {type:'divider',icon:'‚Äî',name:'Divider',desc:'Visual separator'},
    {type:'page_link',icon:'‚Üó',name:'Page Link',desc:'Link to another page'},
  ]},
];

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
(async function boot(){
  try {
    await refreshPages();
    setupKeys();
    lucide.createIcons();
  } catch(e){ console.error('Boot:',e); }
})();

// ‚îÄ‚îÄ Pages ‚îÄ‚îÄ
async function refreshPages(){
  pages = await api('/pages');
  renderSidebar();
}

function renderSidebar(){
  const roots = pages.filter(p => !p.parent_id);
  const favs = pages.filter(p => p.is_favorite);
  
  document.getElementById('favorites-list').innerHTML = favs.length
    ? favs.map(p => pageItemHTML(p)).join('')
    : '<div style="padding:4px 8px;font-size:12px;color:var(--text4)">No favorites</div>';
  
  document.getElementById('page-list').innerHTML = roots.length
    ? roots.map(p => pageTreeHTML(p)).join('')
    : '';
  
  lucide.createIcons();
}

function pageItemHTML(p){
  const active = currentPage && currentPage.id === p.id ? ' active' : '';
  return `<div class="page-item${active}" onclick="loadPage('${p.id}')" oncontextmenu="pageMenu(event,'${p.id}')">
    <span class="p-icon">${p.icon||'üìÑ'}</span>
    <span class="p-title">${esc(p.title)}</span>
  </div>`;
}

function pageTreeHTML(p){
  const children = pages.filter(c => c.parent_id === p.id);
  const active = currentPage && currentPage.id === p.id ? ' active' : '';
  const hasKids = children.length > 0;
  let html = `<div class="page-tree-node">
    <div class="page-item${active}" onclick="loadPage('${p.id}')" oncontextmenu="pageMenu(event,'${p.id}')">
      ${hasKids ? `<span class="p-toggle" onclick="event.stopPropagation();toggleChildren(this)"><i data-lucide="chevron-right" style="width:12px;height:12px"></i></span>` : '<span style="width:12px"></span>'}
      <span class="p-icon">${p.icon||'üìÑ'}</span>
      <span class="p-title">${esc(p.title)}</span>
      <span class="p-add" onclick="event.stopPropagation();createPage('${p.id}')"><i data-lucide="plus" style="width:12px;height:12px"></i></span>
    </div>`;
  if (hasKids){
    html += `<div class="page-children">${children.map(c=>pageTreeHTML(c)).join('')}</div>`;
  }
  return html + '</div>';
}

function toggleChildren(el){
  const node = el.closest('.page-tree-node');
  const kids = node.querySelector('.page-children');
  if(kids) kids.classList.toggle('collapsed');
  const icon = el.querySelector('svg');
  if(icon) icon.style.transform = kids?.classList.contains('collapsed') ? '' : 'rotate(90deg)';
}

async function createPage(parentId){
  const page = await api('/pages', {method:'POST', body:{title:'Untitled', parent_id:parentId||null, icon:'üìù'}});
  await refreshPages();
  await loadPage(page.id);
}

async function loadPage(id){
  const data = await api('/pages/'+id);
  currentPage = data;
  currentBlocks = data.blocks || [];
  renderPage();
  renderSidebar();
  document.getElementById('welcome').style.display = 'none';
}

function renderPage(){
  if(!currentPage) return;
  const area = document.getElementById('page-area');
  
  let breadcrumbs = buildBreadcrumbs(currentPage);
  document.getElementById('breadcrumbs').innerHTML = breadcrumbs;
  
  let html = '<div class="page-content">';
  
  // Header
  html += `<div class="page-header">
    <div class="page-icon" onclick="openIconPicker(this,'${currentPage.id}')">${currentPage.icon||'üìÑ'}</div>
    <div class="page-title" contenteditable="true" placeholder="Untitled" data-page-id="${currentPage.id}"
      oninput="onTitleChange(this)" onkeydown="if(event.key==='Enter'){event.preventDefault();focusFirstBlock()}">${esc(currentPage.title)}</div>
    <div class="page-header-actions">
      <button class="meta-btn" onclick="openIconPicker(document.querySelector('.page-icon'),'${currentPage.id}')"><i data-lucide="smile" style="width:12px;height:12px"></i> Icon</button>
    </div>
  </div>`;
  
  // Blocks
  html += '<div id="blocks-container">';
  let bulletNum = 0;
  currentBlocks.forEach((b,i) => {
    if(b.type === 'numbered') bulletNum++; else bulletNum = 0;
    html += blockHTML(b, i, bulletNum);
  });
  html += '</div>';
  
  // Click to add
  html += `<div style="min-height:200px;cursor:text" onclick="addBlockAtEnd()"></div>`;
  html += '</div>';
  
  area.innerHTML = html;
  lucide.createIcons();
  setupBlockListeners();
}

function blockHTML(b, i, num){
  const indent = b.indent_level || 0;
  const props = typeof b.properties === 'string' ? JSON.parse(b.properties || '{}') : (b.properties || {});
  
  if(b.type === 'todo'){
    const checked = props.checked ? ' checked' : '';
    return `<div class="block${props.checked?' checked':''}" data-id="${b.id}" data-type="todo" data-indent="${indent}">
      <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
      <div class="block-content"><input type="checkbox"${checked} onchange="toggleTodo('${b.id}',this.checked)"><div class="todo-text" contenteditable="true" data-block-id="${b.id}" data-placeholder="To-do">${esc(b.content)}</div></div>
    </div>`;
  }
  
  if(b.type === 'divider'){
    return `<div class="block" data-id="${b.id}" data-type="divider" data-indent="${indent}">
      <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
      <div class="block-content"></div>
    </div>`;
  }
  
  if(b.type === 'callout'){
    const icon = props.icon || 'üí°';
    return `<div class="block" data-id="${b.id}" data-type="callout" data-indent="${indent}">
      <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
      <span class="callout-icon">${icon}</span>
      <div class="block-content" contenteditable="true" data-block-id="${b.id}" data-placeholder="Type something...">${esc(b.content)}</div>
    </div>`;
  }
  
  if(b.type === 'page_link'){
    return `<div class="block" data-id="${b.id}" data-type="page_link" data-indent="${indent}" onclick="loadPage('${b.content}')">
      <div class="block-handle"><span class="block-add" onclick="event.stopPropagation();addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span></div>
      <div class="block-content"><i data-lucide="file-text" style="width:14px;height:14px"></i> ${esc(props.title||b.content)}</div>
    </div>`;
  }
  
  const ph = b.type==='h1'?'Heading 1':b.type==='h2'?'Heading 2':b.type==='h3'?'Heading 3':
    b.type==='quote'?'Quote':b.type==='code'?'Code':b.type==='bullet'?'List':
    b.type==='numbered'?'List':"Type '/' for commands";
  
  return `<div class="block" data-id="${b.id}" data-type="${b.type}" data-indent="${indent}">
    <div class="block-handle"><span class="block-add" onclick="addBlockAfter('${b.id}')"><i data-lucide="plus" style="width:14px;height:14px"></i></span><span class="block-drag" draggable="true"><i data-lucide="grip-vertical" style="width:14px;height:14px"></i></span></div>
    <div class="block-content" contenteditable="true" data-block-id="${b.id}" data-placeholder="${ph}"${b.type==='numbered'?' data-number="'+num+'"':''}>${esc(b.content)}</div>
  </div>`;
}

function setupBlockListeners(){
  // Click anywhere on block ‚Üí focus the contenteditable
  document.querySelectorAll('.block').forEach(block => {
    block.addEventListener('click', e => {
      if(e.target.closest('.block-handle') || e.target.closest('input[type="checkbox"]')) return;
      const editable = block.querySelector('[data-block-id]') || block.querySelector('.todo-text');
      if(editable && document.activeElement !== editable) { editable.focus(); }
    });
  });
  document.querySelectorAll('[data-block-id]').forEach(el => {
    el.addEventListener('input', () => saveBlock(el.dataset.blockId, el.innerText));
    el.addEventListener('keydown', e => blockKeyDown(e, el));
    el.addEventListener('blur', () => {
      // Flush any pending save immediately on blur
      const bid = el.dataset.blockId;
      if(saveTimers[bid]){ clearTimeout(saveTimers[bid]); saveTimers[bid]=null; }
      const b = currentBlocks.find(b=>b.id===bid);
      if(b && b.content !== el.innerText){ b.content = el.innerText; api('/blocks/'+bid, {method:'PUT', body:{content:el.innerText}}); }
    });
  });
  // Todo text fields also need save + keydown
  document.querySelectorAll('.todo-text[data-block-id]').forEach(el => {
    el.addEventListener('input', () => saveBlock(el.dataset.blockId, el.innerText));
    el.addEventListener('keydown', e => blockKeyDown(e, el));
    el.addEventListener('blur', () => {
      const bid = el.dataset.blockId;
      if(saveTimers[bid]){ clearTimeout(saveTimers[bid]); saveTimers[bid]=null; }
      const b = currentBlocks.find(b=>b.id===bid);
      if(b && b.content !== el.innerText){ b.content = el.innerText; api('/blocks/'+bid, {method:'PUT', body:{content:el.innerText}}); }
    });
  });
  // Format bar on selection
  document.addEventListener('selectionchange', showFormatBar);
}

// ‚îÄ‚îÄ Block Operations ‚îÄ‚îÄ
let saveTimers = {};
function saveBlock(id, content){
  clearTimeout(saveTimers[id]);
  // Update local state immediately
  const b = currentBlocks.find(b=>b.id===id);
  if(b) b.content = content;
  saveTimers[id] = setTimeout(() => {
    api('/blocks/'+id, {method:'PUT', body:{content}}).catch(e => console.error('Save failed:', e));
  }, 500);
}

function blockKeyDown(e, el){
  const bid = el.dataset.blockId;
  
  // If slash menu is open, handle keys there first
  if(document.getElementById('slash-menu').classList.contains('open')){
    if(e.key === 'ArrowDown'){e.preventDefault();slashIdx++;renderSlashMenu(el.innerText);return;}
    if(e.key === 'ArrowUp'){e.preventDefault();slashIdx=Math.max(0,slashIdx-1);renderSlashMenu(el.innerText);return;}
    if(e.key === 'Enter'){
      e.preventDefault();
      const item = document.querySelector('.slash-item.focused');
      if(item) selectSlashItem(item.dataset.type);
      return;
    }
    if(e.key === 'Escape'){
      e.preventDefault();hideSlashMenu();el.innerText='';
      const b=currentBlocks.find(b=>b.id===bid);if(b)b.content='';
      api('/blocks/'+bid,{method:'PUT',body:{content:''}});
      return;
    }
    // Let other keys through for filtering
    return;
  }
  
  // Slash command ‚Äî don't preventDefault, let '/' be typed for filtering
  if(e.key === '/' && el.innerText === ''){
    setTimeout(() => showSlashMenu(el, bid), 10);
    return;
  }
  
  // Enter ‚Äî new block
  if(e.key === 'Enter' && !e.shiftKey){
    const block = currentBlocks.find(b=>b.id===bid);
    if(block && (block.type==='code')) return; // allow newlines in code
    e.preventDefault();
    // If in a list, continue list type
    const newType = (block && ['bullet','numbered','todo'].includes(block.type) && el.innerText.trim() !== '') ? block.type : 'text';
    // If empty list item, convert to text
    if(block && ['bullet','numbered','todo'].includes(block.type) && el.innerText.trim() === ''){
      api('/blocks/'+bid, {method:'PUT', body:{type:'text'}});
      block.type = 'text';
      renderPage();
      focusBlock(bid);
      return;
    }
    addBlockAfter(bid, newType);
    return;
  }
  
  // Backspace on empty ‚Äî delete block
  if(e.key === 'Backspace' && el.innerText.trim() === ''){
    e.preventDefault();
    const idx = currentBlocks.findIndex(b=>b.id===bid);
    if(idx > 0){
      const prevId = currentBlocks[idx-1].id;
      deleteBlock(bid, prevId, true);
    } else if(currentBlocks.length > 1){
      const nextId = currentBlocks[1]?.id;
      deleteBlock(bid, nextId, false);
    }
    return;
  }
  
  // Tab ‚Äî indent
  if(e.key === 'Tab'){
    e.preventDefault();
    const block = currentBlocks.find(b=>b.id===bid);
    if(!block) return;
    const newIndent = e.shiftKey ? Math.max(0, (block.indent_level||0)-1) : Math.min(3, (block.indent_level||0)+1);
    block.indent_level = newIndent;
    api('/blocks/'+bid, {method:'PUT', body:{indent_level:newIndent}});
    const blockEl = document.querySelector(`.block[data-id="${bid}"]`);
    if(blockEl) blockEl.dataset.indent = newIndent;
    return;
  }
  
  // Arrow up/down ‚Äî navigate blocks
  if(e.key === 'ArrowUp'){
    const idx = currentBlocks.findIndex(b=>b.id===bid);
    if(idx > 0){ e.preventDefault(); focusBlock(currentBlocks[idx-1].id, true); }
  }
  if(e.key === 'ArrowDown'){
    const idx = currentBlocks.findIndex(b=>b.id===bid);
    if(idx < currentBlocks.length-1){ e.preventDefault(); focusBlock(currentBlocks[idx+1].id); }
  }
}

async function addBlockAfter(afterId, type='text'){
  const newId = Math.random().toString(36).substr(2,8);
  const block = {id:newId, page_id:currentPage.id, type, content:'', properties:'{}', indent_level:0};
  const idx = currentBlocks.findIndex(b=>b.id===afterId);
  currentBlocks.splice(idx+1, 0, block);
  await api('/pages/'+currentPage.id+'/blocks', {method:'POST', body:{id:newId, type, after_id:afterId}});
  renderPage();
  setTimeout(() => focusBlock(newId), 20);
}

async function addBlockAtEnd(){
  const lastBlock = currentBlocks[currentBlocks.length-1];
  if(lastBlock && lastBlock.content === '') { focusBlock(lastBlock.id); return; }
  const newId = Math.random().toString(36).substr(2,8);
  const block = {id:newId, page_id:currentPage.id, type:'text', content:'', properties:'{}', indent_level:0};
  currentBlocks.push(block);
  await api('/pages/'+currentPage.id+'/blocks', {method:'POST', body:{id:newId, type:'text'}});
  renderPage();
  setTimeout(() => focusBlock(newId), 20);
}

async function deleteBlock(id, focusId, atEnd){
  currentBlocks = currentBlocks.filter(b=>b.id!==id);
  api('/blocks/'+id, {method:'DELETE'});
  renderPage();
  if(focusId) setTimeout(() => focusBlock(focusId, atEnd), 20);
}

function focusBlock(id, atEnd){
  const el = document.querySelector(`[data-block-id="${id}"]`) || document.querySelector(`.todo-text[data-block-id="${id}"]`);
  if(!el) return;
  el.focus();
  if(atEnd && el.innerText.length){
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

function focusFirstBlock(){
  if(currentBlocks.length) focusBlock(currentBlocks[0].id);
}

async function toggleTodo(id, checked){
  const block = currentBlocks.find(b=>b.id===id);
  if(!block) return;
  const props = typeof block.properties === 'string' ? JSON.parse(block.properties||'{}') : (block.properties||{});
  props.checked = checked;
  block.properties = props;
  await api('/blocks/'+id, {method:'PUT', body:{properties:props}});
  const el = document.querySelector(`.block[data-id="${id}"]`);
  if(el) el.classList.toggle('checked', checked);
}

// ‚îÄ‚îÄ Slash Menu ‚îÄ‚îÄ
let slashEl = null;
function showSlashMenu(el, blockId){
  slashBlock = blockId;
  slashEl = el;
  slashIdx = 0;
  const menu = document.getElementById('slash-menu');
  const rect = el.getBoundingClientRect();
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 4) + 'px';
  renderSlashMenu('');
  menu.classList.add('open');
  el.addEventListener('input', slashFilter);
}

function hideSlashMenu(){
  const menu = document.getElementById('slash-menu');
  menu.classList.remove('open');
  if(slashEl) { slashEl.removeEventListener('input', slashFilter); slashEl = null; }
  slashBlock = null;
}

function renderSlashMenu(filter){
  const menu = document.getElementById('slash-menu');
  const fl = filter.toLowerCase().replace('/','');
  let html = '';
  let idx = 0;
  BLOCK_TYPES.forEach(section => {
    const items = section.items.filter(i => !fl || i.name.toLowerCase().includes(fl) || i.type.includes(fl));
    if(!items.length) return;
    html += `<div class="slash-section"><div class="slash-section-title">${section.section}</div>`;
    items.forEach(item => {
      html += `<div class="slash-item${idx===slashIdx?' focused':''}" data-idx="${idx}" data-type="${item.type}" 
        onmousedown="event.preventDefault();selectSlashItem('${item.type}')" onmouseenter="slashIdx=${idx};renderSlashMenu('${fl}')">
        <div class="si-icon">${item.icon}</div>
        <div class="si-info"><div class="si-name">${item.name}</div><div class="si-desc">${item.desc}</div></div>
      </div>`;
      idx++;
    });
    html += '</div>';
  });
  if(!html) html = '<div class="search-empty">No matching blocks</div>';
  menu.innerHTML = html;
}

function slashFilter(e){
  const text = e.target.innerText;
  if(!text.startsWith('/')){hideSlashMenu();return;}
  slashIdx = 0;
  renderSlashMenu(text);
}

function slashKeys(e){
  if(!document.getElementById('slash-menu').classList.contains('open')) return;
  if(e.key === 'ArrowDown'){e.preventDefault();slashIdx++;renderSlashMenu('');}
  if(e.key === 'ArrowUp'){e.preventDefault();slashIdx=Math.max(0,slashIdx-1);renderSlashMenu('');}
  if(e.key === 'Enter'){
    e.preventDefault();
    const item = document.querySelector('.slash-item.focused');
    if(item) selectSlashItem(item.dataset.type);
  }
  if(e.key === 'Escape'){e.preventDefault();hideSlashMenu();e.target.innerText='';}
}

async function selectSlashItem(type){
  const bid = slashBlock;
  hideSlashMenu();
  if(!bid) return;
  const block = currentBlocks.find(b=>b.id===bid);
  if(!block) return;
  
  // Clear content in local state FIRST
  block.content = '';
  block.type = type;
  
  if(type === 'page_link'){
    const newPage = await api('/pages', {method:'POST', body:{title:'Untitled', parent_id:currentPage.id}});
    block.content = newPage.id;
    block.properties = JSON.stringify({title:newPage.title});
    await api('/blocks/'+block.id, {method:'PUT', body:{type:'page_link', content:newPage.id, properties:{title:newPage.title}}});
    await refreshPages();
    renderPage();
    return;
  }
  
  // Render immediately with cleared state, then save to API
  renderPage();
  setTimeout(() => focusBlock(block.id), 20);
  api('/blocks/'+block.id, {method:'PUT', body:{type, content:''}});
}

// ‚îÄ‚îÄ Title ‚îÄ‚îÄ
let titleTimer;
function onTitleChange(el){
  clearTimeout(titleTimer);
  titleTimer = setTimeout(async () => {
    const title = el.innerText.trim() || 'Untitled';
    currentPage.title = title;
    await api('/pages/'+currentPage.id, {method:'PUT', body:{title}});
    await refreshPages();
  }, 500);
}

// ‚îÄ‚îÄ Icon Picker ‚îÄ‚îÄ
function openIconPicker(el, pageId){
  const picker = document.getElementById('icon-picker');
  const rect = el.getBoundingClientRect();
  picker.style.left = rect.left + 'px';
  picker.style.top = (rect.bottom + 4) + 'px';
  picker.innerHTML = `<div style="margin-bottom:8px;font-size:12px;color:var(--text3)">Choose an icon</div>
    <div class="icon-grid">${ICONS.map(i => `<div class="icon-option" onclick="selectIcon('${pageId}','${i}')">${i}</div>`).join('')}</div>
    <button class="btn btn-ghost" style="margin-top:8px;width:100%;font-size:12px" onclick="selectIcon('${pageId}','')">Remove icon</button>`;
  picker.classList.add('open');
  setTimeout(() => document.addEventListener('click', closeIconPicker), 10);
}

function closeIconPicker(e){
  const picker = document.getElementById('icon-picker');
  if(!picker.contains(e?.target)){
    picker.classList.remove('open');
    document.removeEventListener('click', closeIconPicker);
  }
}

async function selectIcon(pageId, icon){
  document.getElementById('icon-picker').classList.remove('open');
  document.removeEventListener('click', closeIconPicker);
  await api('/pages/'+pageId, {method:'PUT', body:{icon}});
  currentPage.icon = icon;
  await refreshPages();
  renderPage();
}

// ‚îÄ‚îÄ Breadcrumbs ‚îÄ‚îÄ
function buildBreadcrumbs(page){
  const chain = [];
  let p = page;
  while(p){
    chain.unshift(p);
    p = p.parent_id ? pages.find(x=>x.id===p.parent_id) : null;
  }
  return chain.map((c,i) => {
    if(i === chain.length-1) return `<span class="current">${c.icon||'üìÑ'} ${esc(c.title)}</span>`;
    return `<span onclick="loadPage('${c.id}')">${c.icon||'üìÑ'} ${esc(c.title)}</span><span class="sep">/</span>`;
  }).join('');
}

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ
function openSearch(initial){
  document.getElementById('search-modal').classList.add('open');
  const input = document.getElementById('search-input');
  input.value = typeof initial === 'string' ? initial : '';
  input.focus();
  if(initial) doSearch(initial);
}

function closeSearch(){
  document.getElementById('search-modal').classList.remove('open');
}

const debounce = (fn,ms) => {let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

async function doSearch(q){
  const el = document.getElementById('search-results');
  if(!q.trim()){el.innerHTML='<div class="search-empty">Type to search</div>';return;}
  const results = await api('/search?q='+encodeURIComponent(q));
  searchIdx = -1;
  if(!results.length){el.innerHTML='<div class="search-empty">No results</div>';return;}
  el.innerHTML = results.map((r,i) => `<div class="search-item${i===searchIdx?' focused':''}" data-id="${r.page_id}" onclick="closeSearch();loadPage('${r.page_id}')">
    <span class="si-icon">${r.icon||'üìÑ'}</span>
    <div><div class="si-title">${esc(r.title)}</div>${r.snippet?`<div class="si-snippet">${esc(r.snippet)}</div>`:''}</div>
  </div>`).join('');
}

function searchKeys(e){
  const items = document.querySelectorAll('.search-item');
  if(e.key==='ArrowDown'){e.preventDefault();searchIdx=Math.min(searchIdx+1,items.length-1);highlightSearch(items);}
  if(e.key==='ArrowUp'){e.preventDefault();searchIdx=Math.max(searchIdx-1,0);highlightSearch(items);}
  if(e.key==='Enter'&&searchIdx>=0&&items[searchIdx]){closeSearch();loadPage(items[searchIdx].dataset.id);}
  if(e.key==='Escape')closeSearch();
}

function highlightSearch(items){
  items.forEach((el,i)=>el.classList.toggle('focused',i===searchIdx));
  if(items[searchIdx])items[searchIdx].scrollIntoView({block:'nearest'});
}

// ‚îÄ‚îÄ Format Bar ‚îÄ‚îÄ
function showFormatBar(){
  const sel = window.getSelection();
  const bar = document.getElementById('format-bar');
  if(!sel.rangeCount || sel.isCollapsed || !sel.anchorNode?.closest?.('[data-block-id]')){
    bar.classList.remove('open');return;
  }
  const range = sel.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  bar.style.left = (rect.left + rect.width/2 - 100) + 'px';
  bar.style.top = (rect.top - 40) + 'px';
  bar.classList.add('open');
}

function execFmt(e, cmd){
  e.preventDefault();
  if(cmd==='code'){
    const sel=window.getSelection();
    if(sel.rangeCount){
      const range=sel.getRangeAt(0);
      const code=document.createElement('code');
      code.style.cssText='background:rgba(0,212,255,.08);padding:1px 4px;border-radius:3px;font-family:"JetBrains Mono",monospace;font-size:.9em';
      range.surroundContents(code);
    }
  } else if(cmd==='link'){
    const url = prompt('Enter URL:');
    if(url) document.execCommand('createLink', false, url);
  } else {
    document.execCommand(cmd);
  }
}

// ‚îÄ‚îÄ Page Menu ‚îÄ‚îÄ
function pageMenu(e, id){
  e.preventDefault();
  e.stopPropagation();
  const page = pages.find(p=>p.id===id);
  if(!page) return;
  
  // Simple context menu using dialog
  const items = [
    {label: page.is_favorite ? 'Remove from favorites' : 'Add to favorites', action: () => toggleFav(id)},
    {label: 'Rename', action: () => renamePage(id)},
    {label: 'Delete', action: () => deletePage(id), danger: true},
  ];
  
  // Use a quick inline menu
  const menu = document.createElement('div');
  menu.style.cssText = `position:fixed;left:${e.clientX}px;top:${e.clientY}px;z-index:200;background:var(--bg3);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5);padding:4px;min-width:160px;animation:menuIn 100ms ease-out`;
  items.forEach(item => {
    const el = document.createElement('div');
    el.style.cssText = `padding:6px 12px;border-radius:4px;cursor:pointer;font-size:13px;color:${item.danger?'var(--red)':'var(--text2)'};transition:background 80ms`;
    el.textContent = item.label;
    el.onmouseover = () => el.style.background = 'var(--card-hover)';
    el.onmouseout = () => el.style.background = 'none';
    el.onclick = () => { document.body.removeChild(menu); item.action(); };
    menu.appendChild(el);
  });
  document.body.appendChild(menu);
  setTimeout(() => document.addEventListener('click', function rm(){ document.body.contains(menu) && document.body.removeChild(menu); document.removeEventListener('click',rm); }), 10);
}

async function toggleFav(id){
  const page = pages.find(p=>p.id===id);
  if(!page) return;
  await api('/pages/'+id, {method:'PUT', body:{is_favorite: page.is_favorite ? 0 : 1}});
  await refreshPages();
}

async function renamePage(id){
  const page = pages.find(p=>p.id===id);
  if(!page) return;
  const title = prompt('New title:', page.title);
  if(!title) return;
  await api('/pages/'+id, {method:'PUT', body:{title}});
  if(currentPage && currentPage.id === id) currentPage.title = title;
  await refreshPages();
  if(currentPage && currentPage.id === id) renderPage();
}

async function deletePage(id){
  if(!confirm('Delete this page and all sub-pages?')) return;
  await api('/pages/'+id, {method:'DELETE'});
  if(currentPage && currentPage.id === id){
    currentPage = null;
    document.getElementById('page-area').innerHTML = '<div class="welcome" id="welcome"><i data-lucide="brain"></i><p>Brain Notes</p><div class="hint">Select a page or create a new one</div></div>';
    lucide.createIcons();
  }
  await refreshPages();
}

// ‚îÄ‚îÄ Keyboard Shortcuts ‚îÄ‚îÄ
function setupKeys(){
  document.addEventListener('keydown', e => {
    if((e.metaKey||e.ctrlKey) && e.key==='k'){e.preventDefault();openSearch();}
    if(e.key==='Escape'){closeSearch();hideSlashMenu();}
  });
  document.addEventListener('click', e => {
    if(!e.target.closest('#slash-menu') && !e.target.closest('[data-block-id]')) hideSlashMenu();
  });
}

// ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// ‚îÄ‚îÄ Dialog ‚îÄ‚îÄ
function showDialog(title, msg, okLabel='Delete', okClass='btn-danger'){
  return new Promise(resolve => {
    dialogCb = resolve;
    document.getElementById('dialog-title').textContent = title;
    document.getElementById('dialog-msg').textContent = msg;
    const btn = document.getElementById('dialog-ok');
    btn.textContent = okLabel;
    btn.className = 'btn ' + okClass;
    document.getElementById('dialog').classList.add('open');
  });
}
function closeDialog(val){
  document.getElementById('dialog').classList.remove('open');
  if(dialogCb){dialogCb(val);dialogCb=null;}
}

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function esc(s){if(!s)return '';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
</script>
</body>
</html>
